---
phase: 01-foundation-objectives
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mcp/perdoo/src/services/perdoo/operations/objectives.ts
  - mcp/perdoo/src/services/perdoo/client.ts
  - mcp/perdoo/src/mcp/index.ts
  - mcp/perdoo/src/mcp/tools/index.ts
  - mcp/perdoo/src/mcp/tools/objectives.ts
  - mcp/perdoo/src/mcp/tools/error-handler.ts
  - mcp/perdoo/src/server.ts
autonomous: true

must_haves:
  truths:
    - "Server starts on port 3001 when PERDOO_API_TOKEN is set"
    - "Server exits with error when PERDOO_API_TOKEN is missing"
    - "GET /health returns 200 with status healthy"
    - "MCP session can be initialized via POST /mcp"
    - "Four objective tools are registered: list_objectives, get_objective, create_objective, update_objective"
    - "Instructions resource is available at perdoo://instructions"
  artifacts:
    - path: "mcp/perdoo/src/server.ts"
      provides: "Express server with MCP transport"
      exports: []
    - path: "mcp/perdoo/src/mcp/tools/index.ts"
      provides: "createMcpServer with tool registration and instructions resource"
      exports: ["createMcpServer"]
    - path: "mcp/perdoo/src/mcp/tools/objectives.ts"
      provides: "Four objective tools registration"
      exports: ["registerObjectiveTools"]
    - path: "mcp/perdoo/src/mcp/tools/error-handler.ts"
      provides: "GraphQL/HTTP error to MCP error mapping"
      exports: ["handleToolError"]
    - path: "mcp/perdoo/src/services/perdoo/operations/objectives.ts"
      provides: "GraphQL query/mutation strings for objectives"
      exports: ["OBJECTIVES_QUERY", "OBJECTIVE_QUERY", "CREATE_OBJECTIVE_MUTATION", "UPDATE_OBJECTIVE_MUTATION"]
  key_links:
    - from: "mcp/perdoo/src/server.ts"
      to: "mcp/perdoo/src/mcp/tools/index.ts"
      via: "createMcpServer() call"
      pattern: "createMcpServer\\(\\)"
    - from: "mcp/perdoo/src/mcp/tools/index.ts"
      to: "mcp/perdoo/src/mcp/tools/objectives.ts"
      via: "registerObjectiveTools(server, client)"
      pattern: "registerObjectiveTools"
    - from: "mcp/perdoo/src/mcp/tools/objectives.ts"
      to: "mcp/perdoo/src/services/perdoo/client.ts"
      via: "client.listObjectives(), client.getObjective(), etc."
      pattern: "client\\.(list|get|create|update)Objective"
    - from: "mcp/perdoo/src/mcp/tools/objectives.ts"
      to: "mcp/perdoo/src/mcp/tools/error-handler.ts"
      via: "handleToolError in catch blocks"
      pattern: "handleToolError\\(error"
---

<objective>
Build the Objective tools, Express MCP transport, and instructions resource to create a fully functional server.

Purpose: Complete the MCP server with all four objective operations (list, get, create, update) and the Express transport layer so the server can accept MCP connections and execute tools.
Output: A runnable server that starts on port 3001, exposes four objective tools and an instructions resource via MCP-over-HTTP.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-RESEARCH.md
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-01-SUMMARY.md

Reference implementation:
@mcp/mrpeasy/src/server.ts
@mcp/mrpeasy/src/mcp/index.ts
@mcp/mrpeasy/src/mcp/tools/index.ts
@mcp/mrpeasy/src/mcp/tools/inventory.ts
@mcp/mrpeasy/src/mcp/tools/error-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Objective operations, typed client methods, and error handler</name>
  <files>
    mcp/perdoo/src/services/perdoo/operations/objectives.ts
    mcp/perdoo/src/services/perdoo/client.ts
    mcp/perdoo/src/mcp/tools/error-handler.ts
  </files>
  <action>
    1. **operations/objectives.ts** -- Create GraphQL operation constants:
       - `OBJECTIVES_QUERY`: query ListObjectives($first: Int, $after: String) -- returns objectives connection with pageInfo + edges containing: id, name, status, progress, timeframe { name }
       - `OBJECTIVE_QUERY`: query GetObjective($id: ID!) -- returns single objective with full fields: id, name, description, status, progress, timeframe { name }, lead { id name }, groups connection, results connection
       - `CREATE_OBJECTIVE_MUTATION`: mutation CreateObjective($input: CreateObjectiveInput!) -- returns createObjective { id name status }
       - `UPDATE_OBJECTIVE_MUTATION`: mutation UpdateObjective($id: ID!, $input: UpdateObjectiveInput!) -- returns updateObjective { id name status progress }
       - NOTE: These signatures are LOW confidence and will be validated/updated after introspection in Plan 03. Use the templates from research as-is.

    2. **client.ts** -- Add typed public methods to PerdooClient (below the execute method):
       - `listObjectives(params?: { first?: number; after?: string }): Promise<ObjectivesData>` -- uses OBJECTIVES_QUERY, default first=20
       - `getObjective(id: string): Promise<ObjectiveData>` -- uses OBJECTIVE_QUERY
       - `createObjective(input: CreateObjectiveInput): Promise<CreateObjectiveData>` -- uses CREATE_OBJECTIVE_MUTATION with isMutation: true
       - `updateObjective(id: string, input: UpdateObjectiveInput): Promise<UpdateObjectiveData>` -- uses UPDATE_OBJECTIVE_MUTATION with isMutation: true
       - `introspect(): Promise<IntrospectionData>` -- uses INTROSPECTION_QUERY
       - Import operation constants from './operations/objectives.js' and './operations/introspection.js'
       - Import types from './types.js'

    3. **mcp/tools/error-handler.ts** -- Create error handler (adapted from research):
       - `handleToolError(error: unknown, toolName: string)` returns `{ content: { type: 'text'; text: string }[]; isError: true }`
       - Handle PerdooHttpError: 401/403 -> auth message, 429 -> rate limit message, other -> unavailable
       - Handle PerdooApiError: isAuthError -> auth message, isRateLimited -> rate limit, other -> show error.message
       - Handle CircuitBreakerOpenError: service unavailable, wait 30s
       - Fallback: unexpected error
       - Private `formatMcpError(message, suggestion)` helper
       - Import error types from '../../services/perdoo/index.js'
       - Import logger from '../../lib/logger.js'
  </action>
  <verify>
    - `cd mcp/perdoo && npx tsc --noEmit` passes
    - `grep "isMutation: true" mcp/perdoo/src/services/perdoo/client.ts` shows create and update methods
    - `grep "OBJECTIVES_QUERY\|OBJECTIVE_QUERY\|CREATE_OBJECTIVE\|UPDATE_OBJECTIVE" mcp/perdoo/src/services/perdoo/operations/objectives.ts` shows all 4 operations
  </verify>
  <done>Four GraphQL operations defined, PerdooClient has typed methods for all objective operations + introspect, error handler maps all error types to MCP format</done>
</task>

<task type="auto">
  <name>Task 2: MCP server, objective tools, instructions resource, and Express transport</name>
  <files>
    mcp/perdoo/src/mcp/index.ts
    mcp/perdoo/src/mcp/tools/index.ts
    mcp/perdoo/src/mcp/tools/objectives.ts
    mcp/perdoo/src/server.ts
  </files>
  <action>
    1. **mcp/tools/objectives.ts** -- Create registerObjectiveTools(server, client):
       Register 4 tools following MRPeasy inventory.ts pattern:

       a) `list_objectives` -- "List objectives from Perdoo with pagination. Returns name, status, progress, and timeframe."
          - Params: limit (z.number().int().min(1).max(50).default(20)), cursor (z.string().optional())
          - Call client.listObjectives({ first: params.limit, after: params.cursor })
          - Flatten relay connection: edges.map(e => e.node)
          - Return JSON with summary, pagination (hasNextPage, endCursor, count), items array

       b) `get_objective` -- "Get a single objective by ID with full details including key results."
          - Params: id (z.string().describe('Objective ID'))
          - Call client.getObjective(params.id)
          - Return objective data as JSON

       c) `create_objective` -- "Create a new objective in Perdoo."
          - Params: name (z.string().min(1).max(200)), description (z.string().optional()), and additional_fields (z.record(z.unknown()).optional().describe('Additional fields discovered via introspection'))
          - Call client.createObjective({ name: params.name, ...(params.description && { description: params.description }), ...params.additional_fields })
          - Return created objective as JSON

       d) `update_objective` -- "Update an existing objective in Perdoo."
          - Params: id (z.string()), fields (z.record(z.unknown()).min(1).describe('Fields to update (e.g., name, description, status)'))
          - Call client.updateObjective(params.id, params.fields as UpdateObjectiveInput)
          - Return updated objective as JSON

       All tools: wrap in try/catch, use handleToolError on error, logger.debug on entry.

    2. **mcp/tools/index.ts** -- Create createMcpServer() function:
       - Create McpServer({ name: 'perdoo-mcp', version: '0.1.0', description: SERVER_DESCRIPTION })
       - SERVER_DESCRIPTION: 'Perdoo OKR integration. Manage objectives, key results, KPIs, and initiatives. Read the perdoo://instructions resource for usage guide.'
       - Register instructions resource at 'perdoo://instructions' with mimeType 'text/markdown'
       - INSTRUCTIONS_RESOURCE content (markdown):
         - Title: "Perdoo MCP Server Instructions"
         - Section "Available Tools": list_objectives, get_objective, create_objective, update_objective with brief descriptions and key params
         - Section "Pagination": Explain cursor-based pagination, limit param, hasNextPage/endCursor usage
         - Section "Entity Relationships": Objectives contain Key Results (results field)
         - Section "Best Practices": Use get_objective for full details, list for browsing, create requires name, update requires id + fields
         - Section "Error Handling": Auth errors mean token issue, rate limits mean wait, circuit breaker means service down
       - Register ping tool (same as MRPeasy)
       - Create client via createPerdooClient()
       - Call registerObjectiveTools(server, client)
       - Return server

    3. **mcp/index.ts** -- Barrel: `export { createMcpServer } from './tools/index.js';`

    4. **src/server.ts** -- Copy from MRPeasy server.ts exactly, change only:
       - Import paths (from './mcp/index.js' etc.)
       - Log message: 'Perdoo MCP server started'
       - Health check version: '0.1.0'
       - Port uses env.PORT (which defaults to 3001 via env.ts)

    Remove the temporary empty server.ts if one was created in Plan 01.
  </action>
  <verify>
    - `cd mcp/perdoo && npx tsc --noEmit` passes with zero errors
    - `cd mcp/perdoo && npm run build` succeeds (creates dist/)
    - `PERDOO_API_TOKEN=test timeout 3 node mcp/perdoo/dist/server.js 2>&1 || true` shows "Perdoo MCP server started" in output
    - `grep -c "server.tool" mcp/perdoo/src/mcp/tools/objectives.ts` returns 4 (four tools registered)
    - `grep "perdoo://instructions" mcp/perdoo/src/mcp/tools/index.ts` confirms instructions resource
  </verify>
  <done>Server starts on port 3001, four objective tools are registered, instructions resource available at perdoo://instructions, health check responds on GET /health</done>
</task>

</tasks>

<verification>
- `cd mcp/perdoo && npm run build` succeeds
- `cd mcp/perdoo && npx tsc --noEmit` reports zero errors
- Server starts and logs "Perdoo MCP server started" with PERDOO_API_TOKEN set
- Server exits immediately with error when PERDOO_API_TOKEN is missing
- Four tools registered: list_objectives, get_objective, create_objective, update_objective
- Instructions resource registered at perdoo://instructions
- Error handler covers PerdooApiError, PerdooHttpError, CircuitBreakerOpenError
</verification>

<success_criteria>
- Complete MCP server that starts, accepts sessions, and exposes objective tools
- All four CRUD operations wired through PerdooClient with proper error handling
- Mutations (create, update) marked with isMutation: true (never retried)
- Relay pagination flattened for LLM consumption in list_objectives
- Instructions resource provides actionable guidance to LLMs
- Express transport handles session lifecycle (POST init, GET SSE, DELETE close)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-objectives/01-02-SUMMARY.md`
</output>
