---
phase: 01-foundation-objectives
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/perdoo/package.json
  - mcp/perdoo/tsconfig.json
  - mcp/perdoo/Dockerfile
  - mcp/perdoo/.env.example
  - mcp/perdoo/src/lib/logger.ts
  - mcp/perdoo/src/lib/env.ts
  - mcp/perdoo/src/lib/errors.ts
  - mcp/perdoo/src/services/perdoo/rate-limiter.ts
  - mcp/perdoo/src/services/perdoo/request-queue.ts
  - mcp/perdoo/src/services/perdoo/circuit-breaker.ts
  - mcp/perdoo/src/services/perdoo/retry.ts
  - mcp/perdoo/src/services/perdoo/types.ts
  - mcp/perdoo/src/services/perdoo/client.ts
  - mcp/perdoo/src/services/perdoo/index.ts
  - mcp/perdoo/src/services/perdoo/operations/introspection.ts
autonomous: true

must_haves:
  truths:
    - "npm install succeeds without errors"
    - "tsc --noEmit passes with zero type errors"
    - "PerdooClient can be instantiated with a token"
    - "Missing PERDOO_API_TOKEN causes validateEnv() to throw"
  artifacts:
    - path: "mcp/perdoo/package.json"
      provides: "Project manifest with all dependencies"
      contains: "@modelcontextprotocol/sdk"
    - path: "mcp/perdoo/src/lib/env.ts"
      provides: "Env validation with fail-fast"
      exports: ["validateEnv", "getEnv"]
    - path: "mcp/perdoo/src/lib/errors.ts"
      provides: "PerdooApiError and PerdooHttpError classes"
      exports: ["PerdooApiError", "PerdooHttpError", "GraphQLError"]
    - path: "mcp/perdoo/src/services/perdoo/client.ts"
      provides: "PerdooClient with execute() method and resilience stack"
      exports: ["PerdooClient"]
    - path: "mcp/perdoo/src/services/perdoo/operations/introspection.ts"
      provides: "Schema introspection query constant"
      exports: ["INTROSPECTION_QUERY"]
  key_links:
    - from: "mcp/perdoo/src/services/perdoo/client.ts"
      to: "rate-limiter.ts, circuit-breaker.ts, retry.ts, request-queue.ts"
      via: "imports and uses in execute() pipeline"
      pattern: "queue\\.enqueue.*circuitBreaker\\.execute.*withRetry.*rateLimiter\\.waitForToken"
    - from: "mcp/perdoo/src/services/perdoo/client.ts"
      to: "mcp/perdoo/src/lib/errors.ts"
      via: "throws PerdooApiError and PerdooHttpError"
      pattern: "throw new Perdoo(Api|Http)Error"
---

<objective>
Scaffold the Perdoo MCP server project and build the GraphQL client with full resilience stack.

Purpose: Establish the entire foundation so subsequent plans can focus on tool implementation. This creates the PerdooClient that all tools will use to communicate with the Perdoo GraphQL API.
Output: A buildable TypeScript project with PerdooClient, resilience stack (queue, circuit breaker, retry, rate limiter), error types, env validation, and introspection query.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-RESEARCH.md

Reference implementation (copy patterns from here):
@mcp/mrpeasy/package.json
@mcp/mrpeasy/tsconfig.json
@mcp/mrpeasy/src/lib/logger.ts
@mcp/mrpeasy/src/lib/env.ts
@mcp/mrpeasy/src/services/mrpeasy/rate-limiter.ts
@mcp/mrpeasy/src/services/mrpeasy/request-queue.ts
@mcp/mrpeasy/src/services/mrpeasy/circuit-breaker.ts
@mcp/mrpeasy/src/services/mrpeasy/retry.ts
@mcp/mrpeasy/src/services/mrpeasy/client.ts
@mcp/mrpeasy/src/services/mrpeasy/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding and lib layer</name>
  <files>
    mcp/perdoo/package.json
    mcp/perdoo/tsconfig.json
    mcp/perdoo/Dockerfile
    mcp/perdoo/.env.example
    mcp/perdoo/src/lib/logger.ts
    mcp/perdoo/src/lib/env.ts
    mcp/perdoo/src/lib/errors.ts
  </files>
  <action>
    Create the project root files and lib/ layer:

    1. **package.json** -- Copy from MRPeasy, change:
       - name: "perdoo-mcp"
       - description: "MCP server for Perdoo OKR GraphQL API integration"
       - version: "0.1.0"
       - Add script: "introspect": "tsx src/scripts/introspect.ts"
       - Port in docker:run: 3001
       - Same dependencies: @modelcontextprotocol/sdk ^1.15.0, express ^4.21.0, zod ^3.25.0
       - Same devDependencies: @types/express ^5.0.0, @types/node ^22.10.7, tsx ^4.19.2, typescript ^5.7.3

    2. **tsconfig.json** -- Copy from MRPeasy exactly (same config works)

    3. **Dockerfile** -- Copy from MRPeasy, change EXPOSE to 3001

    4. **.env.example** -- Contents:
       ```
       PERDOO_API_TOKEN=your-bearer-token-here
       PORT=3001
       NODE_ENV=development
       ```

    5. **src/lib/logger.ts** -- Copy from MRPeasy exactly (same stderr-only logger)

    6. **src/lib/env.ts** -- Copy from MRPeasy, change:
       - Replace MRPEASY_API_KEY and MRPEASY_API_SECRET with single PERDOO_API_TOKEN (string, required, min 1)
       - Default PORT to '3001' (not '3000')
       - Keep NODE_ENV as-is

    7. **src/lib/errors.ts** -- NEW file (not in MRPeasy). Create:
       - `GraphQLError` interface: { message, locations?, path?, extensions?: { code?, [key]: unknown } }
       - `GraphQLResponse<T>` interface: { data: T | null, errors?: GraphQLError[], extensions?: Record<string, unknown> }
       - `PerdooApiError` class extending Error:
         - Constructor takes `GraphQLError[]`
         - Properties: errors, isAuthError, isRateLimited, isRetryable
         - isAuthError: checks extensions.code === 'UNAUTHENTICATED' or message includes 'authentication'/'unauthorized'
         - isRateLimited: checks extensions.code === 'RATE_LIMITED' or message includes 'rate limit'/'throttl'
         - isRetryable: isRateLimited && !isAuthError
       - `PerdooHttpError` class extending Error:
         - Constructor takes (status: number, statusText: string)
         - Properties: status, isRetryable (true for 429, 502, 503, 504)
       - Export all types and classes

    After creating files, run `cd mcp/perdoo && npm install` to install dependencies.
  </action>
  <verify>
    - `cd mcp/perdoo && npm install` exits 0
    - `cd mcp/perdoo && npx tsc --noEmit` has no errors for the lib/ files (may have errors for missing src/server.ts, that is OK)
  </verify>
  <done>package.json installed, tsconfig valid, lib/ layer (logger, env, errors) compiles cleanly with correct exports</done>
</task>

<task type="auto">
  <name>Task 2: Resilience stack and PerdooClient</name>
  <files>
    mcp/perdoo/src/services/perdoo/rate-limiter.ts
    mcp/perdoo/src/services/perdoo/request-queue.ts
    mcp/perdoo/src/services/perdoo/circuit-breaker.ts
    mcp/perdoo/src/services/perdoo/retry.ts
    mcp/perdoo/src/services/perdoo/types.ts
    mcp/perdoo/src/services/perdoo/client.ts
    mcp/perdoo/src/services/perdoo/index.ts
    mcp/perdoo/src/services/perdoo/operations/introspection.ts
  </files>
  <action>
    Create the services/perdoo/ layer with resilience stack and GraphQL client:

    1. **rate-limiter.ts** -- Copy from MRPeasy exactly, change only the factory function:
       - `createRateLimiter()` returns `new TokenBucket(30, 3)` (conservative: 30 capacity, 3 tokens/sec)
       - Update JSDoc comment: "Perdoo rate limits are undocumented; start conservative (30 req/10s effective)"

    2. **request-queue.ts** -- Copy from MRPeasy exactly (same single-concurrency queue)

    3. **circuit-breaker.ts** -- Copy from MRPeasy exactly (same 5 failures, 30s timeout defaults)

    4. **retry.ts** -- Copy from MRPeasy with these changes:
       - Import `PerdooApiError` and `PerdooHttpError` from '../../lib/errors.js' (NOT from client)
       - Change `isRetryable()`:
         - If `PerdooApiError`: return `error.isRetryable` (delegates to error's own classification)
         - If `PerdooHttpError`: return `error.isRetryable` (429, 502, 503, 504)
         - Otherwise: return false
       - Change default maxAttempts to 3 (not 5)
       - Remove Retry-After header handling (GraphQL errors don't have it)
       - Keep exponential backoff and jitter logic identical

    5. **types.ts** -- Create response/input interfaces:
       ```typescript
       // Relay pagination types
       export interface PageInfo { endCursor: string | null; hasNextPage: boolean; }
       export interface Connection<T> { pageInfo: PageInfo; edges: { node: T }[]; }

       // Objective types (confirmed fields from research)
       export interface Objective {
         id: string; name: string; status: string; progress: number;
         timeframe?: { name: string };
         description?: string;
         lead?: { id: string; name: string };
         groups?: Connection<{ id: string; name: string }>;
         results?: Connection<{ id: string; name: string; type: string; normalizedValue: number; status: string }>;
       }

       // Query response shapes
       export interface ObjectivesData { objectives: Connection<Objective>; }
       export interface ObjectiveData { objective: Objective; }
       export interface CreateObjectiveData { createObjective: Objective; }
       export interface UpdateObjectiveData { updateObjective: Objective; }

       // Input types (placeholders -- will be refined after introspection)
       export interface CreateObjectiveInput { name: string; [key: string]: unknown; }
       export interface UpdateObjectiveInput { [key: string]: unknown; }

       // Introspection
       export interface IntrospectionData { __schema: unknown; }
       ```

    6. **client.ts** -- Create PerdooClient class:
       - Config interface: `{ token: string; endpoint?: string; maxRetries?: number }`
       - Constructor: set endpoint default 'https://api-eu.perdoo.com/graphql/', create rateLimiter, queue, circuitBreaker
       - `execute<T>(operation, variables?, options?: { isMutation?: boolean; operationName?: string })`:
         Pipeline: queue.enqueue -> circuitBreaker.execute -> (if !isMutation: withRetry(fn)) else fn() -> rateLimiter.waitForToken -> executeRequest
       - `private executeRequest<T>(operation, variables?, operationName?)`:
         - fetch POST to endpoint with Bearer token, Content-Type: application/json
         - Body: { query: operation, variables, ...(operationName && { operationName }) }
         - If !response.ok: throw PerdooHttpError
         - Parse JSON as GraphQLResponse<T>
         - If json.errors?.length: throw PerdooApiError(json.errors)
         - If !json.data: throw PerdooApiError([{ message: 'No data returned' }])
         - Return json.data
       - Import GraphQLResponse from '../../lib/errors.js'
       - Import resilience stack from local files
       - DO NOT add typed public methods yet (those come in Plan 02 with the operations)
       - Export PerdooClient and PerdooClientConfig

    7. **index.ts** -- Barrel exports (copy pattern from MRPeasy):
       - Re-export from types.ts, client.ts, errors (PerdooApiError, PerdooHttpError from lib)
       - Re-export CircuitBreakerOpenError from circuit-breaker.ts
       - Re-export resilience utilities (TokenBucket, RequestQueue, withRetry, CircuitBreaker + factories)
       - Memoized `createPerdooClient()` factory (uses getEnv().PERDOO_API_TOKEN)
       - `resetPerdooClient()` for testing

    8. **operations/introspection.ts** -- Create the introspection query constant exactly as shown in research (INTROSPECTION_QUERY discovering queryType fields, mutationType fields, types with fields/inputFields/enumValues)
  </action>
  <verify>
    - `cd mcp/perdoo && npx tsc --noEmit` passes with zero type errors (ignoring missing server.ts/mcp/ files -- create a temporary empty src/server.ts if needed for tsc to pass, containing just `export {}`)
    - All imports resolve correctly between lib/ and services/
  </verify>
  <done>PerdooClient compiles cleanly, resilience stack (queue -> circuit breaker -> retry -> rate limiter) is wired in execute(), introspection query constant exists, all types exported from barrel</done>
</task>

</tasks>

<verification>
- `cd mcp/perdoo && npm install` succeeds
- `cd mcp/perdoo && npx tsc --noEmit` reports zero errors
- `grep -r "PerdooApiError" mcp/perdoo/src/` shows usage in retry.ts and client.ts
- `grep "isMutation" mcp/perdoo/src/services/perdoo/client.ts` confirms mutation guard exists
- `grep "TokenBucket(30, 3)" mcp/perdoo/src/services/perdoo/rate-limiter.ts` confirms conservative limits
</verification>

<success_criteria>
- Project installs and typechecks successfully
- PerdooClient.execute() implements the full resilience pipeline: queue -> circuit breaker -> retry (queries only) -> rate limiter -> fetch
- Mutations are never retried (isMutation flag skips withRetry)
- GraphQL errors (200 with errors array) are detected and thrown as PerdooApiError
- HTTP errors thrown as PerdooHttpError
- Env validation requires PERDOO_API_TOKEN and fails fast when missing
- Introspection query constant is ready to execute
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-objectives/01-01-SUMMARY.md`
</output>
