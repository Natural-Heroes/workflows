---
phase: 01-foundation-objectives
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - mcp/perdoo/src/scripts/introspect.ts
  - mcp/perdoo/src/services/perdoo/operations/objectives.ts
  - mcp/perdoo/src/services/perdoo/types.ts
  - mcp/perdoo/src/mcp/tools/objectives.ts
  - mcp/perdoo/src/mcp/tools/index.ts
autonomous: false

must_haves:
  truths:
    - "Introspection script runs and outputs schema information"
    - "Objective operations match actual Perdoo GraphQL schema"
    - "Server starts and can list objectives from real Perdoo API"
    - "LLM instructions resource accurately describes available tools"
  artifacts:
    - path: "mcp/perdoo/src/scripts/introspect.ts"
      provides: "Standalone script to run introspection query"
      min_lines: 20
    - path: "mcp/perdoo/src/services/perdoo/operations/objectives.ts"
      provides: "Corrected GraphQL operations matching real schema"
      exports: ["OBJECTIVES_QUERY", "OBJECTIVE_QUERY", "CREATE_OBJECTIVE_MUTATION", "UPDATE_OBJECTIVE_MUTATION"]
  key_links:
    - from: "mcp/perdoo/src/scripts/introspect.ts"
      to: "mcp/perdoo/src/services/perdoo/client.ts"
      via: "PerdooClient.introspect() call"
      pattern: "client\\.introspect\\(\\)"
    - from: "operations/objectives.ts"
      to: "Perdoo GraphQL schema"
      via: "Query/mutation names match introspection output"
      pattern: "(query|mutation)\\s+\\w+"
---

<objective>
Run schema introspection against real Perdoo API, update operations to match actual schema, and validate end-to-end.

Purpose: The operation signatures (query names, mutation names, input types) are LOW confidence guesses. Introspection discovers the real schema so tools actually work. This is the validation step that proves the entire Phase 1 integration pattern.
Output: Corrected operations matching real schema, a reusable introspection script, and a verified working server.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-RESEARCH.md
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-01-SUMMARY.md
@mcp/perdoo/.planning/phases/01-foundation-objectives/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create introspection script and run against Perdoo API</name>
  <files>
    mcp/perdoo/src/scripts/introspect.ts
  </files>
  <action>
    Create a standalone introspection script at src/scripts/introspect.ts:

    1. Import PerdooClient from '../services/perdoo/index.js' (or instantiate directly)
    2. Read PERDOO_API_TOKEN from process.env (simple check, no full env validation needed for script)
    3. Create PerdooClient with the token
    4. Call client.introspect()
    5. Output results to stdout as formatted JSON
    6. Additionally, parse and log to stderr a summary of:
       - All query fields (names and their argument names/types)
       - All mutation fields (names and their argument names/types)
       - Any types containing "Objective" in their name (show their fields/inputFields)
       - Any enum types related to objectives (status enums, etc.)
    7. Handle errors gracefully: if introspection fails, log the error clearly

    Then run the script: `cd mcp/perdoo && PERDOO_API_TOKEN=$PERDOO_API_TOKEN npx tsx src/scripts/introspect.ts`

    Save the full output to `.planning/phases/01-foundation-objectives/introspection-output.json` for reference.

    Analyze the output to determine:
    - Correct query name for listing objectives (is it `objectives`, `allObjectives`, etc.?)
    - Correct query name for single objective (is it `objective`, `getObjective`?)
    - Correct mutation names (is it `createObjective`, `objectiveCreate`?)
    - Exact input type names and their required/optional fields
    - Available filter arguments on list query
    - Correct field names on Objective type
  </action>
  <verify>
    - `cd mcp/perdoo && npx tsx src/scripts/introspect.ts` produces JSON output (with PERDOO_API_TOKEN set)
    - Introspection output shows queryType and mutationType fields
    - Objective-related types are visible in the output
  </verify>
  <done>Introspection script exists and has been run, schema structure for objectives is known</done>
</task>

<task type="auto">
  <name>Task 2: Update operations and types to match real schema</name>
  <files>
    mcp/perdoo/src/services/perdoo/operations/objectives.ts
    mcp/perdoo/src/services/perdoo/types.ts
    mcp/perdoo/src/services/perdoo/client.ts
    mcp/perdoo/src/mcp/tools/objectives.ts
    mcp/perdoo/src/mcp/tools/index.ts
  </files>
  <action>
    Based on the introspection results from Task 1, update all files to match the real Perdoo schema:

    1. **operations/objectives.ts** -- Update query/mutation strings:
       - Fix query names if different from assumed (objectives, objective, createObjective, updateObjective)
       - Fix argument names and types to match actual schema
       - Fix field names in selection sets to match actual Objective type
       - Fix input type names (CreateObjectiveInput, UpdateObjectiveInput may have different names)
       - Ensure all requested fields actually exist on the Objective type

    2. **types.ts** -- Update interfaces:
       - Fix Objective interface to match actual fields from introspection
       - Fix input type interfaces (CreateObjectiveInput, UpdateObjectiveInput) to use actual required/optional fields
       - Fix response data type names if mutation return types differ
       - Add any enum types discovered (e.g., ObjectiveStatus)

    3. **client.ts** -- Update typed methods if:
       - Method signatures need different parameter names
       - Variable names passed to execute() need updating
       - Operation names differ

    4. **mcp/tools/objectives.ts** -- Update tool params if:
       - create_objective needs different required fields (not just name)
       - update_objective field names differ
       - list_objectives has additional filter params available (add them with z.optional())

    5. **mcp/tools/index.ts** -- Update INSTRUCTIONS_RESOURCE:
       - Reflect actual available fields and params
       - Update tool descriptions if behavior differs from assumed

    After updates: `cd mcp/perdoo && npm run build` must succeed.
  </action>
  <verify>
    - `cd mcp/perdoo && npm run build` succeeds
    - `cd mcp/perdoo && npx tsc --noEmit` passes
    - Operation strings use correct query/mutation names per introspection
    - Types match actual schema fields
  </verify>
  <done>All operations, types, and tools match the real Perdoo GraphQL schema as discovered by introspection</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete Perdoo MCP server with:
    - Project scaffolding (package.json, tsconfig, Dockerfile)
    - GraphQL client with resilience stack (queue, circuit breaker, retry, rate limiter)
    - Four objective tools (list, get, create, update) validated against real schema
    - Instructions resource at perdoo://instructions
    - Express MCP-over-HTTP transport on port 3001
  </what-built>
  <how-to-verify>
    1. Start the server: `cd mcp/perdoo && PERDOO_API_TOKEN=<your-token> npm run dev`
    2. Verify health: `curl http://localhost:3001/health` -- should return { status: "healthy" }
    3. Test MCP connection: Initialize a session via POST /mcp with an initialize request
    4. Test list_objectives tool: call it via MCP and verify it returns objectives from Perdoo
    5. Test get_objective: pick an ID from the list result and retrieve full details
    6. Verify server exits cleanly when PERDOO_API_TOKEN is unset: `npm run dev` without env var should fail fast
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- Introspection script runs and discovers real schema
- Operations match actual Perdoo GraphQL API (no field/query name mismatches)
- Server builds and starts: `npm run build && PERDOO_API_TOKEN=test node dist/server.js`
- TypeScript compiles with zero errors
- Tools execute against real Perdoo API and return data
</verification>

<success_criteria>
- Schema introspection has been run and results saved
- All four objective operations use correct schema (query/mutation names, field names, input types)
- Server starts on port 3001 and lists real objectives from Perdoo
- Fail-fast works: missing token = immediate exit with clear error
- Instructions resource accurately describes the available tools
- Phase 1 success criteria met:
  1. Server starts with valid token, fails without
  2. LLM can list objectives with pagination
  3. LLM can create and retrieve an objective
  4. LLM can update an objective
  5. Instructions resource describes tools
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-objectives/01-03-SUMMARY.md`
</output>
