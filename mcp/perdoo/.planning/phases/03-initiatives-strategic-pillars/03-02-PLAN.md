---
phase: 03-initiatives-strategic-pillars
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/services/perdoo/operations/strategic-pillars.ts
  - src/services/perdoo/types.ts
  - src/services/perdoo/client.ts
  - src/mcp/tools/strategic-pillars.ts
  - src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "LLM can list strategic pillars with filtering by status, lead, archived"
    - "LLM can get a single strategic pillar by UUID with full details"
    - "LLM can create a strategic pillar (if API mutation exists)"
    - "LLM can update an existing strategic pillar (if API mutation exists)"
    - "Strategic pillars are correctly filtered from polymorphic Goal type using type enum"
    - "Instructions resource documents strategic pillar tools and permission requirements"
  artifacts:
    - path: "src/services/perdoo/operations/strategic-pillars.ts"
      provides: "STRATEGIC_PILLARS_QUERY, STRATEGIC_PILLAR_QUERY, and mutation if discovered"
      exports: ["STRATEGIC_PILLARS_QUERY", "STRATEGIC_PILLAR_QUERY"]
    - path: "src/services/perdoo/types.ts"
      provides: "StrategicPillar interface, StrategicPillarsData, StrategicPillarData types"
      contains: "StrategicPillar"
    - path: "src/services/perdoo/client.ts"
      provides: "listStrategicPillars, getStrategicPillar, and mutation methods if available"
      contains: "listStrategicPillars"
    - path: "src/mcp/tools/strategic-pillars.ts"
      provides: "2-4 MCP tools depending on mutation availability"
      exports: ["registerStrategicPillarTools"]
    - path: "src/mcp/tools/index.ts"
      provides: "Strategic pillar tools registered + instructions updated"
      contains: "registerStrategicPillarTools"
  key_links:
    - from: "src/mcp/tools/strategic-pillars.ts"
      to: "src/services/perdoo/client.ts"
      via: "client.listStrategicPillars, client.getStrategicPillar"
      pattern: "client\\.listStrategicPillars|client\\.getStrategicPillar"
    - from: "src/services/perdoo/client.ts"
      to: "src/services/perdoo/operations/strategic-pillars.ts"
      via: "STRATEGIC_PILLARS_QUERY, STRATEGIC_PILLAR_QUERY imports"
      pattern: "import.*STRATEGIC_PILLARS_QUERY.*from.*operations/strategic-pillars"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/strategic-pillars.ts"
      via: "registerStrategicPillarTools import and call"
      pattern: "registerStrategicPillarTools"
---

<objective>
Introspect the Goal type schema and build strategic pillar MCP tools.

Purpose: Strategic pillars are the final entity type needed for full API coverage. Unlike initiatives (which reuse proven infrastructure), strategic pillars require schema discovery first because the Goal type fields, enum values, and mutations are unknown. The number of tools created (2 read-only or 4 full CRUD) depends on whether a Goal mutation exists in the API.

Output: Schema introspection results informing the implementation, followed by 2-4 MCP tools for strategic pillars (list, get, and optionally create/update).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-initiatives-strategic-pillars/03-RESEARCH.md
@.planning/phases/03-initiatives-strategic-pillars/03-01-SUMMARY.md

Key source files:
@src/services/perdoo/operations/kpis.ts
@src/services/perdoo/types.ts
@src/services/perdoo/client.ts
@src/mcp/tools/kpis.ts
@src/mcp/tools/index.ts
@src/scripts/introspect.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introspect Goal schema and build operations + types + client</name>
  <files>
    src/services/perdoo/operations/strategic-pillars.ts
    src/services/perdoo/types.ts
    src/services/perdoo/client.ts
  </files>
  <action>
    **Step 1: Introspect the Goal type and related enums.**

    Run these GraphQL queries against the Perdoo API using the existing client infrastructure. Create a temporary script or use the client directly via a one-off tsx script. The PERDOO_API_TOKEN env var must be set.

    Queries to run (in order of priority):

    ```graphql
    # 1. Goal type fields
    { __type(name: "Goal") { name kind fields { name type { name kind ofType { name kind ofType { name kind } } } } } }

    # 2. PerdooApiGoalTypeChoices enum (CRITICAL - need the type filter value for strategic pillars)
    { __type(name: "PerdooApiGoalTypeChoices") { name kind enumValues { name } } }

    # 3. PerdooApiGoalStatusChoices enum
    { __type(name: "PerdooApiGoalStatusChoices") { name kind enumValues { name } } }

    # 4. GoalType enum
    { __type(name: "GoalType") { name kind enumValues { name } } }

    # 5. Mutation type - search for goal-related mutations
    { __type(name: "Mutation") { name fields { name args { name type { name kind ofType { name kind } } } type { name kind ofType { name kind } } } } }
    ```

    If query 5 finds a goal mutation (upsertGoal, createGoal, etc.), also introspect the mutation input type:
    ```graphql
    { __type(name: "UpsertGoalMutationInput") { name kind inputFields { name type { name kind ofType { name kind ofType { name kind } } } } } }
    ```
    Try alternative names if needed: CreateGoalMutationInput, UpdateGoalMutationInput, UpsertStrategicPillarMutationInput.

    Log all introspection results to stderr for debugging. Use the results to build the implementation below.

    **Step 2: Create `src/services/perdoo/operations/strategic-pillars.ts`:**

    Based on introspection results:

    - Export `STRATEGIC_PILLARS_QUERY`: Uses `goals(...)` root query. Include the `type` variable set to the correct PerdooApiGoalTypeChoices enum value for strategic pillars (discovered in introspection step). Variables: $first: Int, $after: String, $type: PerdooApiGoalTypeChoices (hardcoded in the query default or passed), $status: PerdooApiGoalStatusChoices, $lead_Id: UUID, $archived: Boolean, $orderBy: String, $parent_Id: UUID. Return fields from Goal type introspection (at minimum: id, name, plus whatever other fields exist).

    - Export `STRATEGIC_PILLAR_QUERY`: Uses `goal(id: UUID!)` root query. Return all fields from Goal type introspection.

    - If a goal mutation was discovered: Export `UPSERT_STRATEGIC_PILLAR_MUTATION` (or appropriate mutation constant). Use the discovered mutation name and input type.

    - If NO goal mutation exists: Do NOT create a mutation constant. Add a comment: `// No goal mutation found in API. Strategic pillars are read-only.`

    - Follow the same JSDoc commenting style as operations/kpis.ts

    **Step 3: Add types to `src/services/perdoo/types.ts`:**

    Based on Goal type introspection results:

    - Add any new enums discovered (PerdooApiGoalTypeChoices values, PerdooApiGoalStatusChoices values, etc.) as TypeScript type unions
    - Add `StrategicPillar` interface with fields from Goal type introspection. Use existing types where applicable (PerdooUser for lead, PerdooGroup for groups, PerdooTimeframe for timeframe, Connection<T> for relay connections)
    - Add `StrategicPillarsData`: `{ goals: Connection<StrategicPillar> }`
    - Add `StrategicPillarData`: `{ goal: StrategicPillar }`
    - If mutation exists: Add `UpsertStrategicPillarData` response type and `UpsertStrategicPillarInput` input type
    - Place in new section: `// Strategic Pillar Types`

    **Step 4: Add client methods to `src/services/perdoo/client.ts`:**

    - Import new operations and types
    - Add section: `// Strategic Pillar Operations`
    - Add `listStrategicPillars(params?)`: Uses STRATEGIC_PILLARS_QUERY. The `type` parameter should be pre-set to the correct enum value (LLM should not need to specify it). Parameters: first, after, status, lead_Id, archived, orderBy, parent_Id. Returns StrategicPillarsData.
    - Add `getStrategicPillar(id: string)`: Uses STRATEGIC_PILLAR_QUERY. Returns StrategicPillarData.
    - If mutation exists:
      - Add `createStrategicPillar(input)`: Uses mutation, mark isMutation: true
      - Add `updateStrategicPillar(id, input)`: Uses mutation with id, mark isMutation: true
    - Follow same JSDoc style as existing methods

    **Important decision logic:**
    - If PerdooApiGoalTypeChoices has a value like "STRATEGIC_PILLAR", "PILLAR", or "STRATEGY" -- use that as the type filter
    - If the enum values are unclear, try calling `goals(first: 1, type: <value>)` to verify which returns strategic pillars
    - If no Goal mutation is found in the Mutation type, skip create/update client methods entirely
    - If mutation exists but returns permission errors during testing, still implement the methods but document the Superadmin requirement in tool descriptions
  </action>
  <verify>
    Run `npx tsc --noEmit` from the project root. No type errors for new/modified files. Verify that introspection results are logged (check stderr output from the introspection script run).
  </verify>
  <done>
    - Goal type fields discovered and documented in operations file comments
    - PerdooApiGoalTypeChoices enum value for strategic pillars identified and used
    - operations/strategic-pillars.ts has list and get queries with correct fields
    - types.ts has StrategicPillar interface, response types, and relevant enums
    - client.ts has strategic pillar methods (at minimum list + get; create/update if mutation found)
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Strategic pillar MCP tools and instructions update</name>
  <files>
    src/mcp/tools/strategic-pillars.ts
    src/mcp/tools/index.ts
  </files>
  <action>
    1. Create `src/mcp/tools/strategic-pillars.ts`:
       - Export `registerStrategicPillarTools(server: McpServer, client: PerdooClient): void`
       - Import z from 'zod', McpServer type, PerdooClient type, logger, handleToolError

       **list_strategic_pillars:**
       - Description: 'List Perdoo strategic pillars with pagination and filters. Strategic pillars define long-term focus areas that objectives align to. Can filter by status, lead, archived. Returns flattened list.'
       - Parameters: limit (int, 1-100, default 20), cursor (string, optional), status (enum from discovered PerdooApiGoalStatusChoices values, optional), lead_id (string, optional), archived (boolean, optional), order_by (string, optional), parent_id (string, optional - for sub-pillars if supported)
       - Handler: calls client.listStrategicPillars mapping params
       - Response: Flatten edges/node. Summary uses "strategic pillar(s)". Response key is `strategicPillars`.

       **get_strategic_pillar:**
       - Description: 'Get a single Perdoo strategic pillar by UUID with full details including description, lead, and aligned objectives/KPIs.'
       - Parameters: id (string, required)
       - Handler: calls client.getStrategicPillar(id)
       - Response: Flatten same pattern as other get tools.

       **If mutation was found in Task 1:**

       **create_strategic_pillar:**
       - Description: 'Create a new Perdoo strategic pillar. Name is required. Requires Superadmin permissions in Perdoo. Strategic pillars define long-term focus areas for the organization.'
       - Parameters: Based on mutation input type discovery. At minimum: name (string, required), description (string, optional), lead (string, optional), plus any other discovered input fields.
       - Handler: calls client.createStrategicPillar(input)
       - Response: Same pattern as other create tools.

       **update_strategic_pillar:**
       - Description: 'Update an existing Perdoo strategic pillar by UUID. Requires Superadmin permissions in Perdoo.'
       - Parameters: id (string, required), plus optional fields from mutation input type.
       - Handler: calls client.updateStrategicPillar(id, input)
       - Response: Same pattern as other update tools.

       **If NO mutation was found:**
       - Do NOT create create/update tools
       - Add a comment at the end of the file: `// Note: No Goal mutation found in Perdoo API. Strategic pillars are read-only via this MCP server.`

       - End with `logger.info('Strategic pillar tools registered');`

    2. Update `src/mcp/tools/index.ts`:
       - Add import: `import { registerStrategicPillarTools } from './strategic-pillars.js';`
       - Add call after registerInitiativeTools: `registerStrategicPillarTools(server, client);`
       - Update INSTRUCTIONS_RESOURCE to add Strategic Pillars section after Initiatives:
         ```
         ### Strategic Pillars
         - **list_strategic_pillars**: List strategic pillars with pagination and filters. Supports `limit`, `cursor`, `status`, `lead_id`, `archived`, `order_by`.
         - **get_strategic_pillar**: Get a single strategic pillar by UUID with full details.
         ```
         If mutation tools exist, also add:
         ```
         - **create_strategic_pillar**: Create a new strategic pillar. `name` is required. Requires Superadmin permissions.
         - **update_strategic_pillar**: Update an existing strategic pillar by UUID. Requires Superadmin permissions.
         ```
       - Add to Key Concepts:
         ```
         ### Strategic Pillars
         - Strategic pillars are long-term focus areas that define organizational direction
         - Objectives and KPIs can align to a strategic pillar via their `goal` field
         - Creating/modifying strategic pillars requires Superadmin permissions in Perdoo
         - Strategic pillars are NOT time-bound (unlike OKRs which have timeframes)
         ```
       - Add to Filtering section:
         ```
         ### list_strategic_pillars filters:
         - `status`: Filter by goal status
         - `lead_id`: Filter by lead user UUID
         - `archived`: Filter by archived status
         - `parent_id`: Filter by parent pillar UUID (for sub-pillars)
         ```
       - Update Entity Relationships to add:
         - **Strategic Pillars** are long-term focus areas for the organization
         - **Objectives** can align to a **Strategic Pillar** (via goal field on create/update)
         - **KPIs** can align to a **Strategic Pillar** (via goal field on create/update)
       - Update Mutations section (only if mutations exist):
         - **create_strategic_pillar** / **update_strategic_pillar**: Uses goal mutation (name TBD from introspection). Requires Superadmin permissions.
       - If read-only, add a Limitations section:
         ```
         ## Limitations
         - **Strategic Pillars are read-only**: The Perdoo API does not expose a public mutation for creating or modifying strategic pillars. Use the Perdoo web interface for pillar management.
         ```
  </action>
  <verify>
    Run `npx tsc --noEmit` and then `npm run build`. Verify the built output includes strategic-pillars.js. Grep for "registerStrategicPillarTools" in the built index.js to confirm registration.
  </verify>
  <done>
    - tools/strategic-pillars.ts exports registerStrategicPillarTools with 2-4 tools
    - tools/index.ts imports and calls registerStrategicPillarTools
    - INSTRUCTIONS_RESOURCE includes strategic pillar documentation
    - If read-only: Limitations section clearly explains the constraint
    - If CRUD: Superadmin requirement documented in tool descriptions
    - Full build succeeds without errors
    - All applicable PILLAR requirements (PILLAR-01, PILLAR-02, and optionally PILLAR-03, PILLAR-04) are covered
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes (type safety)
2. `npm run build` succeeds (production build)
3. Grep for "registerStrategicPillarTools" in tools/index.ts confirms registration
4. Grep for "list_strategic_pillars" in tools/strategic-pillars.ts confirms tool exists
5. Grep for "STRATEGIC_PILLARS_QUERY" in operations/strategic-pillars.ts confirms query
6. Grep for "PerdooApiGoalTypeChoices" or the discovered enum value in the query confirms correct type filtering
7. INSTRUCTIONS_RESOURCE contains "### Strategic Pillars" section
8. If read-only: INSTRUCTIONS_RESOURCE contains "## Limitations" section
</verification>

<success_criteria>
- Goal type schema successfully introspected (fields, enums, mutations discovered)
- Strategic pillars correctly filtered from polymorphic Goal type using discovered enum value
- At minimum: list_strategic_pillars and get_strategic_pillar tools work
- If mutation exists: create_strategic_pillar and update_strategic_pillar tools work with Superadmin note
- If no mutation: Read-only limitation clearly documented in instructions
- Instructions resource fully documents strategic pillar tools, concepts, and relationships
- TypeScript builds without errors
- All 5 Perdoo entity types now have MCP tool coverage (objectives, key results, initiatives, KPIs, strategic pillars)
</success_criteria>

<output>
After completion, create `.planning/phases/03-initiatives-strategic-pillars/03-02-SUMMARY.md`
</output>
