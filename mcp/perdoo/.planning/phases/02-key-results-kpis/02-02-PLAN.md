---
phase: 02-key-results-kpis
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/services/perdoo/operations/kpis.ts
  - src/services/perdoo/types.ts
  - src/services/perdoo/client.ts
  - src/mcp/tools/kpis.ts
  - src/mcp/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "LLM can list KPIs with filtering by name, lead, group, status, and company goal flag"
    - "LLM can get a single KPI by ID with full details"
    - "LLM can create a KPI with name and relevant properties"
    - "LLM can update an existing KPI's properties"
    - "Instructions resource documents all Key Result and KPI tools"
  artifacts:
    - path: "src/services/perdoo/operations/kpis.ts"
      provides: "GraphQL query and mutation strings for KPIs"
      contains: "KPIS_QUERY"
    - path: "src/services/perdoo/types.ts"
      provides: "Kpi interface, UpsertKpiInput, response types"
      contains: "interface Kpi"
    - path: "src/services/perdoo/client.ts"
      provides: "listKpis, getKpi, createKpi, updateKpi methods"
      contains: "listKpis"
    - path: "src/mcp/tools/kpis.ts"
      provides: "4 MCP tools: list_kpis, get_kpi, create_kpi, update_kpi"
      contains: "registerKpiTools"
    - path: "src/mcp/tools/index.ts"
      provides: "KPI tool registration + updated INSTRUCTIONS_RESOURCE"
      contains: "registerKpiTools"
  key_links:
    - from: "src/mcp/tools/kpis.ts"
      to: "src/services/perdoo/client.ts"
      via: "client.listKpis/getKpi/createKpi/updateKpi calls"
      pattern: "client\\.(list|get|create|update)Kpi"
    - from: "src/services/perdoo/client.ts"
      to: "src/services/perdoo/operations/kpis.ts"
      via: "imported query/mutation constants"
      pattern: "KPIS_QUERY|KPI_QUERY|UPSERT_KPI"
    - from: "src/mcp/tools/index.ts"
      to: "src/mcp/tools/kpis.ts"
      via: "registerKpiTools import and call"
      pattern: "registerKpiTools"
---

<objective>
Introspect KPI schema, implement full KPI CRUD as MCP tools, and update the instructions resource to document all Key Result and KPI tools.

Purpose: Completes Phase 2 by giving LLMs full KPI management capability and comprehensive tool documentation.
Output: 4 new MCP tools (list_kpis, get_kpi, create_kpi, update_kpi) plus updated instructions covering all 12 tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-key-results-kpis/02-RESEARCH.md
@.planning/phases/02-key-results-kpis/02-01-SUMMARY.md

# Source files (replicate KR pattern for KPIs):
@src/services/perdoo/operations/key-results.ts
@src/services/perdoo/types.ts
@src/services/perdoo/client.ts
@src/mcp/tools/key-results.ts
@src/mcp/tools/objectives.ts
@src/mcp/tools/index.ts
@src/mcp/tools/error-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Introspect KPI schema and create operations + types</name>
  <files>src/services/perdoo/operations/kpis.ts, src/services/perdoo/types.ts</files>
  <action>
Run targeted __type introspection queries for KPI entities. If Plan 01 saved introspection output for KPI types, use that. Otherwise run:

1. KPI type fields:
   ```
   '{ __type(name: \"kpi\") { name kind fields { name type { name kind ofType { name kind ofType { name kind } } } } } }'
   ```

2. KPI mutations (if not already found in Plan 01's Mutation type introspection):
   Filter Mutation type fields for "kpi" or "Kpi" names. Expected: `upsertKpi` based on pattern.

3. KPI input type:
   ```
   '{ __type(name: \"UpsertKpiMutationInput\") { name kind inputFields { name type { name kind ofType { name kind ofType { name kind } } } } } }'
   ```

4. Any KPI-specific enums discovered from the type fields.

**CRITICAL:** Use real introspection data. Do NOT guess. The kpi(id: UUID!) singular query IS confirmed to exist from research.

After introspection, create:

**src/services/perdoo/operations/kpis.ts:**
- `KPIS_QUERY`: List query using `allKpis(...)` root query (NOTE: NOT `kpis` -- confirmed as `allKpis`). Include filter variables: name_Icontains, lead_Id, group, archived, status_In, isCompanyGoal, goal_Id, parent, tags_Id, orderBy. Select scalar fields + lead{id,name} + parent{id,name} for list view.
- `KPI_QUERY`: Get-by-ID using confirmed `kpi(id: UUID!)` query. Select ALL fields from introspection.
- `UPSERT_KPI_MUTATION`: Upsert mutation using discovered name and input type. Select core fields in response.

Follow the exact pattern from `operations/objectives.ts` and `operations/key-results.ts`:
- JSDoc comments
- Relay pagination (pageInfo + edges + node)
- UUID! scalar for IDs
- Django-style filter arg names

**src/services/perdoo/types.ts (additions):**
- Add `Kpi` interface with all fields from __type introspection (expect value/measurement fields like currentValue, targetValue, unit, etc.)
- Add `KpisData` response type (allKpis connection wrapper)
- Add `KpiData` response type (singular wrapper)
- Add `UpsertKpiData` response type (mutation result with errors array)
- Add `UpsertKpiInput` interface from introspected input fields
- Add any new KPI-specific enums
- Reference existing types (PerdooUser, PerdooGroup, PerdooTag, CommitStatus, Connection, PageInfo)
  </action>
  <verify>
- `npx tsc --noEmit` passes
- kpis.ts exports KPIS_QUERY, KPI_QUERY, UPSERT_KPI_MUTATION
- types.ts exports Kpi, KpisData, KpiData, UpsertKpiData, UpsertKpiInput
- KPIS_QUERY uses `allKpis` (not `kpis`) as query name
- KPI_QUERY uses `kpi(id: UUID!)` as singular query
  </verify>
  <done>
- KPI operations file exists with schema-correct GraphQL queries/mutations
- Types file extended with KPI entity types matching real Perdoo schema
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client methods, register KPI tools, update instructions, and validate</name>
  <files>src/services/perdoo/client.ts, src/mcp/tools/kpis.ts, src/mcp/tools/index.ts</files>
  <action>
**src/services/perdoo/client.ts (additions):**

Add 4 typed methods following the Key Result pattern:

1. `listKpis(params?)` - Parameters: first (default 20), after, name_Icontains, lead_Id, group, archived, status_In, isCompanyGoal, goal_Id, parent, tags_Id, orderBy. Returns KpisData.

2. `getKpi(id: string)` - Takes UUID. Returns KpiData.

3. `createKpi(input: Omit<UpsertKpiInput, 'id'>)` - isMutation: true. Returns UpsertKpiData.

4. `updateKpi(id: string, input: Omit<UpsertKpiInput, 'id'>)` - Spreads input with id, isMutation: true. Returns UpsertKpiData.

Import new operations and types.

**src/mcp/tools/kpis.ts (new file):**

Create `registerKpiTools(server: McpServer, client: PerdooClient): void`:

1. `list_kpis` tool:
   - Description: "List Perdoo KPIs with pagination and filters. Can filter by name, lead, group, status, company goal flag. Returns flattened list."
   - Zod params: limit (1-100, default 20), cursor (optional), name_contains (optional), lead_id (optional), group_id (optional), archived (optional boolean), status (optional), is_company_goal (optional boolean)
   - Handler: call client.listKpis, flatten, include pagination

2. `get_kpi` tool:
   - Description: "Get a single Perdoo KPI by UUID with full details including value, target, and status."
   - Zod params: id (required)
   - Handler: call client.getKpi, flatten, return full detail

3. `create_kpi` tool:
   - Description: "Create a new KPI in Perdoo. Name is required."
   - Zod params: name (required), plus other fields from UpsertKpiInput as optional, additional_fields record
   - Handler: call client.createKpi, check errors, return success

4. `update_kpi` tool:
   - Description: "Update an existing Perdoo KPI by UUID."
   - Zod params: id (required), all others optional, additional_fields record
   - Handler: call client.updateKpi, check errors, return success

All tools: handleToolError, logger.debug, flatten relay, JSON stringify response.

**src/mcp/tools/index.ts (modifications):**

1. Import registerKpiTools from './kpis.js'
2. Call `registerKpiTools(server, client)` after registerKeyResultTools
3. Update INSTRUCTIONS_RESOURCE to document ALL tools (objectives + key results + KPIs):

Add to the instructions:
- Key Results section: list_key_results, get_key_result, create_key_result, update_key_result with parameter descriptions
- KPIs section: list_kpis, get_kpi, create_kpi, update_kpi with parameter descriptions
- Entity Relationships section: add KR->Objective and KPI->Goal relationships
- Key Concepts section: add Key Result type choices enum (if discovered) and KPI status concepts
- Filtering section: add KR and KPI filter options
- Best Practices: add KR/KPI-specific guidance (e.g., "always specify objective when creating a key result")

**Final validation:**

After all code is written:
1. Run `npx tsc --noEmit` -- must pass
2. Run `npm run build` -- must succeed
3. Verify server starts: `PERDOO_API_TOKEN=test timeout 3 node dist/index.js 2>&1 || true` (check for import errors, not auth errors)
4. If possible, run a real API test: `PERDOO_API_TOKEN=$PERDOO_API_TOKEN npx tsx -e "import { createPerdooClient } from './src/services/perdoo/index.js'; const c = createPerdooClient(); const r = await c.listKpis({ first: 1 }); console.log(JSON.stringify(r, null, 2));"` to verify at least one KPI tool works against the real API.
  </action>
  <verify>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Server starts without import errors
- Grep: registerKpiTools called in index.ts
- Grep: INSTRUCTIONS_RESOURCE contains "list_key_results" and "list_kpis"
- Grep: client.ts has listKpis, getKpi, createKpi, updateKpi
- kpis.ts exports registerKpiTools
  </verify>
  <done>
- Client has 4 typed KPI methods (list, get, create, update)
- 4 MCP tools registered (list_kpis, get_kpi, create_kpi, update_kpi)
- Instructions resource documents all 12 tools (4 objective + 4 KR + 4 KPI)
- Full build passes, server starts cleanly
- Phase 2 success criteria met: all 8 requirements (KR-01..04, KPI-01..04) addressed
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` -- zero type errors
- `npm run build` -- compiles successfully
- Server starts without import/module errors
- INSTRUCTIONS_RESOURCE contains documentation for all 12 tools
- All 4 KPI tools registered and functional
- Phase 2 success criteria:
  1. LLM can list and get key results with filtering (from Plan 01)
  2. LLM can create/update key results under objectives (from Plan 01)
  3. LLM can list and get KPIs with filtering (this plan)
  4. LLM can create and update KPIs (this plan)
</verification>

<success_criteria>
- 4 KPI MCP tools operational (list, get, create, update)
- All GraphQL operations match real Perdoo schema (introspection-verified)
- Instructions resource comprehensively documents all tools
- Full TypeScript build passes
- Server starts and registers all 12 tools without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-key-results-kpis/02-02-SUMMARY.md`
</output>
