---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/mcp/index.ts
  - src/mcp/tools/ping.ts
  - src/mcp/tools/test-odoo.ts
  - src/server.ts
autonomous: true

must_haves:
  truths:
    - "Server starts on configured port and responds to GET /health with JSON status"
    - "MCP client can initialize a session via POST /mcp and receive a session ID"
    - "The ping tool returns 'pong' confirming MCP protocol connectivity"
    - "The test_odoo tool calls Odoo JSON-2 API and returns model data using the API key from x-odoo-api-key header"
    - "Multiple sessions maintain separate user contexts via different API keys"
    - "Idle sessions are evicted after 30 minutes without memory leaks"
    - "Server shuts down gracefully on SIGTERM/SIGINT (closes transports, clears intervals)"
  artifacts:
    - path: "src/server.ts"
      provides: "Express app with POST/GET/DELETE /mcp, health check, session TTL sweep, graceful shutdown"
      min_lines: 100
    - path: "src/mcp/index.ts"
      provides: "createMcpServer factory that registers tools with per-user OdooClient"
      exports: ["createMcpServer"]
    - path: "src/mcp/tools/ping.ts"
      provides: "Connectivity test tool returning pong"
      exports: ["registerPingTool"]
    - path: "src/mcp/tools/test-odoo.ts"
      provides: "Test tool that calls Odoo search_read and returns results"
      exports: ["registerTestOdooTool"]
  key_links:
    - from: "src/server.ts"
      to: "src/mcp/index.ts"
      via: "createMcpServer(clientManager, apiKey) call on session init"
      pattern: "createMcpServer"
    - from: "src/server.ts"
      to: "src/services/odoo/client-manager.ts"
      via: "OdooClientManager instantiation at startup"
      pattern: "new OdooClientManager"
    - from: "src/mcp/tools/test-odoo.ts"
      to: "src/services/odoo/client-manager.ts"
      via: "clientManager.getClient(apiKey) for per-user Odoo access"
      pattern: "clientManager.getClient"
    - from: "src/server.ts"
      to: "session TTL sweep"
      via: "setInterval checking lastActivity timestamps"
      pattern: "setInterval"
---

<objective>
Implement the MCP server with session management, TTL cleanup, test tools, and graceful shutdown.

Purpose: Deliver a working MCP server that Claude clients can connect to, with per-user session isolation via API key header (Phase 1 auth) and automatic cleanup of idle sessions.
Output: A fully functional server that satisfies all Phase 1 success criteria: accepts connections, calls Odoo, isolates sessions, evicts idle sessions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Prior plan output (from Plan 01):
@src/lib/env.ts
@src/lib/logger.ts
@src/lib/errors.ts
@src/services/odoo/client.ts
@src/services/odoo/client-manager.ts

Reference implementation:
@/Users/nevilhulspas/Code/workflows/mcp/mrpeasy/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP server factory and test tools</name>
  <files>
    src/mcp/tools/ping.ts
    src/mcp/tools/test-odoo.ts
    src/mcp/index.ts
  </files>
  <action>
    1. Create `src/mcp/tools/ping.ts`:
       - Export function registerPingTool(server: McpServer): void
       - Register tool 'ping' with description 'Test MCP connectivity. Returns pong.'
       - Empty input schema (no parameters)
       - Handler returns: { content: [{ type: 'text', text: 'pong' }] }

    2. Create `src/mcp/tools/test-odoo.ts`:
       - Import { z } from 'zod', OdooClientManager, McpServer
       - Export function registerTestOdooTool(server: McpServer, clientManager: OdooClientManager, apiKey: string): void
       - Register tool 'test_odoo' with description 'Test Odoo JSON-2 API connectivity. Reads records from a specified model.'
       - Input schema: { model: z.string().default('res.users').describe('Odoo model to query'), limit: z.number().min(1).max(10).default(5).describe('Number of records to return') }
       - Handler:
         * const client = clientManager.getClient(apiKey)
         * const result = await client.searchRead(params.model, [['id', '>', 0]], ['name', 'display_name'], { limit: params.limit })
         * return { content: [{ type: 'text', text: JSON.stringify(result, null, 2) }] }
       - Wrap in try/catch: on OdooApiError, return formatErrorForMcp(createOdooApiError(...))
       - On generic error: return formatErrorForMcp(createUnexpectedError(error))

    3. Create `src/mcp/index.ts`:
       - Import McpServer from '@modelcontextprotocol/sdk/server/mcp.js'
       - Import OdooClientManager, registerPingTool, registerTestOdooTool
       - Export function createMcpServer(clientManager: OdooClientManager, apiKey: string): McpServer
       - Create McpServer with: name 'odoo-mcp', version '0.1.0', description 'Odoo ERP integration for Natural Heroes team.'
       - Call registerPingTool(server)
       - Call registerTestOdooTool(server, clientManager, apiKey)
       - Return server

    4. Run `npx tsc --noEmit` to verify MCP layer compiles.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `grep -r "server.tool" src/mcp/tools/` shows both tool registrations
    - `grep -r "createMcpServer" src/mcp/index.ts` confirms factory export
  </verify>
  <done>
    MCP server factory creates a server with ping and test_odoo tools. test_odoo uses the per-user OdooClient from the manager. Error responses are LLM-friendly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Express server with session management and graceful shutdown</name>
  <files>
    src/server.ts
  </files>
  <action>
    Create `src/server.ts` following the mrpeasy pattern exactly, but adding: (1) session TTL sweep, (2) API key extraction, (3) graceful shutdown.

    Structure:

    1. Imports:
       - express, { Request, Response } from 'express'
       - { randomUUID } from 'crypto'
       - { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHttp.js'
       - { isInitializeRequest } from '@modelcontextprotocol/sdk/types.js'
       - { logger } from './lib/logger.js'
       - { validateEnv, getEnv } from './lib/env.js'
       - { createMcpServer } from './mcp/index.js'
       - { OdooClientManager } from './services/odoo/client-manager.js'

    2. Environment validation (fail fast, same as mrpeasy):
       - try { validateEnv() } catch { logger.error(...); process.exit(1) }
       - const env = getEnv()

    3. Session store with per-user context:
       ```typescript
       interface SessionEntry {
         transport: StreamableHTTPServerTransport;
         server: McpServer;
         lastActivity: number;
         apiKey: string;
       }
       const sessions = new Map<string, SessionEntry>();
       ```

    4. Session TTL sweep (Pattern 1 from research):
       - const SESSION_TTL_MS = 30 * 60 * 1000 (30 minutes)
       - const SWEEP_INTERVAL_MS = 60 * 1000 (60 seconds)
       - const sweepInterval = setInterval(() => { ... sweep logic ... }, SWEEP_INTERVAL_MS)
       - Sweep: iterate sessions, if (now - session.lastActivity > SESSION_TTL_MS): call session.transport.close(), sessions.delete(id), log eviction
       - Add sweepInterval.unref() so it doesn't keep the process alive

    5. Touch helper:
       - function touchSession(sessionId: string): void - updates lastActivity to Date.now()

    6. OdooClientManager instantiation:
       - const clientManager = new OdooClientManager(env.ODOO_URL, env.ODOO_DATABASE)
       - Log startup info with clientManager config

    7. Express app setup:
       - const app = express()
       - app.use(express.json())

    8. GET /health endpoint:
       - Return { status: 'healthy', version: '0.1.0', sessions: sessions.size, clients: clientManager.size }

    9. POST /mcp endpoint (follows mrpeasy pattern + API key auth):
       - Extract sessionId from mcp-session-id header
       - Extract apiKey from x-odoo-api-key header
       - Case 1: sessionId exists and sessions.has(sessionId):
         * touchSession(sessionId)
         * Reuse existing transport: await session.transport.handleRequest(req, res, req.body)
       - Case 2: !sessionId && isInitializeRequest(req.body):
         * If !apiKey: return 401 JSON { error: 'Missing x-odoo-api-key header' }
         * Create StreamableHTTPServerTransport with sessionIdGenerator: () => randomUUID()
         * onsessioninitialized: (id) => sessions.set(id, { transport, server, lastActivity: Date.now(), apiKey })
         * transport.onclose: find and delete from sessions map (same loop as mrpeasy)
         * const server = createMcpServer(clientManager, apiKey)
         * await server.connect(transport)
         * await transport.handleRequest(req, res, req.body)
       - Case 3: sessionId && !sessions.has(sessionId):
         * Return 400: { jsonrpc: '2.0', error: { code: -32000, message: 'Invalid session ID. Session may have expired.' }, id: null }
       - Case 4: else (no sessionId, not initialize):
         * Return 400: { jsonrpc: '2.0', error: { code: -32000, message: 'Missing mcp-session-id header. Initialize session first.' }, id: null }
       - Wrap all in try/catch, return 500 on unexpected errors

    10. GET /mcp endpoint (SSE, same as mrpeasy):
        - Extract sessionId, validate, get transport, handleRequest

    11. DELETE /mcp endpoint (same as mrpeasy):
        - Extract sessionId, validate, get transport, handleRequest, delete from sessions

    12. Graceful shutdown (Pattern from research, Pitfall 6):
        - function setupGracefulShutdown(httpServer: ReturnType<typeof app.listen>): void
        - On SIGTERM/SIGINT:
          * logger.info(`Received ${signal}, shutting down gracefully`)
          * httpServer.close()
          * Close all sessions (iterate, transport.close(), sessions.delete())
          * clearInterval(sweepInterval)
          * clientManager.clear()
          * logger.info('Shutdown complete')
          * process.exit(0)

    13. Start server:
        - const httpServer = app.listen(env.PORT, () => { logger.info('Odoo MCP server started', { port, env, sessions: 0 }) })
        - setupGracefulShutdown(httpServer)

    14. Run `npx tsc --noEmit` to verify full project compiles.
    15. Run `npx tsx src/server.ts &` briefly to verify it starts (then kill it).
        - IMPORTANT: The server will fail to start if ODOO_URL and ODOO_DATABASE are not set.
        - Create a `.env` file temporarily with: PORT=3000, NODE_ENV=development, ODOO_URL=https://example.odoo.com, ODOO_DATABASE=test-db, LOG_LEVEL=debug
        - Start server, verify /health returns 200, then kill it
        - Remove the temporary .env file (it should not be committed)
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - Start server with test .env, `curl http://localhost:3000/health` returns JSON with status: healthy
    - `grep "setInterval" src/server.ts` confirms TTL sweep exists
    - `grep "SIGTERM" src/server.ts` confirms graceful shutdown exists
    - `grep "x-odoo-api-key" src/server.ts` confirms API key extraction
    - `grep "touchSession" src/server.ts` confirms activity tracking
  </verify>
  <done>
    Server starts, accepts MCP connections via POST /mcp with API key auth, maintains per-user sessions with TTL sweep (30min idle eviction), serves SSE via GET /mcp, terminates sessions via DELETE /mcp, and shuts down gracefully on SIGTERM/SIGINT.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration smoke test</name>
  <files></files>
  <action>
    Verify the complete system works end-to-end by running the server and testing the MCP protocol flow manually.

    1. Create a temporary `.env` file:
       ```
       PORT=3000
       NODE_ENV=development
       ODOO_URL=https://naturalheroes-odoo.odoo.com
       ODOO_DATABASE=naturalheroes-odoo-main-18594498
       LOG_LEVEL=debug
       ```

    2. Start the server in background: `npx tsx src/server.ts &`
       - Wait 2 seconds for startup
       - Verify health: `curl -s http://localhost:3000/health | jq .`
       - Expected: { status: "healthy", version: "0.1.0", sessions: 0, clients: 0 }

    3. Test MCP initialize (ping tool):
       ```bash
       curl -s -X POST http://localhost:3000/mcp \
         -H "Content-Type: application/json" \
         -H "x-odoo-api-key: test-key-123" \
         -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}' \
         -D - | head -20
       ```
       - Expected: Response includes mcp-session-id header and initialize result

    4. Test missing API key returns 401:
       ```bash
       curl -s -X POST http://localhost:3000/mcp \
         -H "Content-Type: application/json" \
         -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'
       ```
       - Expected: 401 with error message about missing x-odoo-api-key

    5. Test invalid session returns 400:
       ```bash
       curl -s -X POST http://localhost:3000/mcp \
         -H "Content-Type: application/json" \
         -H "mcp-session-id: nonexistent-session" \
         -d '{"jsonrpc":"2.0","id":1,"method":"tools/list","params":{}}'
       ```
       - Expected: 400 with error about invalid session ID

    6. Kill the server process.
    7. Remove the temporary .env file.
    8. Build the TypeScript: `npx tsc` (produces dist/ directory)
    9. Verify dist/server.js exists and is valid: `node --check dist/server.js`

    NOTE: Do NOT test the test_odoo tool with a real API key. The smoke test only verifies protocol-level functionality (initialize, error handling, health). The actual Odoo connectivity will be tested manually by the user with their real API key.
  </action>
  <verify>
    - Health endpoint returns 200 with correct JSON structure
    - MCP initialize returns a session ID in response headers
    - Missing API key returns 401
    - Invalid session returns 400
    - `npx tsc` produces dist/server.js without errors
    - `node --check dist/server.js` passes
  </verify>
  <done>
    Server starts, handles MCP protocol correctly, enforces API key requirement, rejects invalid sessions, and compiles to production-ready JavaScript. Phase 1 success criteria 1-4 are verifiable.
  </done>
</task>

</tasks>

<verification>
Phase 1 success criteria mapping:
1. "Server starts and accepts streamable HTTP connections" -> GET /health returns 200, POST /mcp with initialize returns session ID
2. "A test tool can call Odoo's JSON-2 API" -> test_odoo tool registered, uses OdooClient.searchRead() with user's API key
3. "Multiple concurrent sessions maintain separate user contexts" -> Each session stores its own apiKey, clientManager creates separate OdooClient per key
4. "Idle sessions are evicted after TTL" -> setInterval sweep checks lastActivity, evicts after 30min, transport.close() called

Additional checks:
- No console.log in any file (grep confirms)
- Graceful shutdown handles SIGTERM + SIGINT
- TypeScript compiles to dist/ without errors
</verification>

<success_criteria>
1. `curl http://localhost:3000/health` returns { status: "healthy", sessions: 0, clients: 0 }
2. POST /mcp with initialize request + x-odoo-api-key header returns session ID
3. POST /mcp without x-odoo-api-key returns 401
4. Server creates separate OdooClient for each unique API key (verified via clientManager.size in /health)
5. Session sweep interval is active (logged at startup)
6. SIGTERM triggers graceful shutdown (logged)
7. `npx tsc` produces valid dist/server.js
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
