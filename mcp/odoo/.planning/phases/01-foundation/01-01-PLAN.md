---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .env.example
  - .gitignore
  - src/lib/env.ts
  - src/lib/logger.ts
  - src/lib/errors.ts
  - src/services/odoo/types.ts
  - src/services/odoo/client.ts
  - src/services/odoo/client-manager.ts
autonomous: true

must_haves:
  truths:
    - "Project compiles without errors via tsc --noEmit"
    - "OdooClient can POST to /json/2/<model>/<method> with bearer auth and return typed JSON"
    - "OdooClientManager caches clients by API key and evicts idle entries after TTL"
    - "Environment variables are validated at import time with clear error messages"
  artifacts:
    - path: "package.json"
      provides: "Project metadata and dependency declarations"
      contains: "@modelcontextprotocol/sdk"
    - path: "tsconfig.json"
      provides: "TypeScript compilation config (ESM, Node 20+)"
      contains: "NodeNext"
    - path: "src/lib/env.ts"
      provides: "Zod-validated environment config"
      exports: ["validateEnv", "getEnv", "Env"]
    - path: "src/lib/logger.ts"
      provides: "Structured stderr-only logger"
      exports: ["logger"]
    - path: "src/lib/errors.ts"
      provides: "McpToolError and Odoo-specific error helpers"
      exports: ["McpToolError", "OdooApiError", "formatErrorForMcp"]
    - path: "src/services/odoo/client.ts"
      provides: "OdooClient class wrapping native fetch for JSON-2 API"
      exports: ["OdooClient"]
    - path: "src/services/odoo/client-manager.ts"
      provides: "LRU cache of per-user OdooClient instances"
      exports: ["OdooClientManager"]
  key_links:
    - from: "src/services/odoo/client.ts"
      to: "Odoo JSON-2 API"
      via: "native fetch POST to /json/2/<model>/<method>"
      pattern: "fetch.*json/2"
    - from: "src/services/odoo/client-manager.ts"
      to: "src/services/odoo/client.ts"
      via: "LRU cache creating OdooClient instances"
      pattern: "new OdooClient"
    - from: "src/lib/env.ts"
      to: "process.env"
      via: "Zod schema parse"
      pattern: "envSchema.safeParse"
---

<objective>
Scaffold the Odoo MCP server project and implement the Odoo JSON-2 API client with per-user caching.

Purpose: Establish the project foundation (TypeScript, ESM, dependencies) and build the core service layer that all MCP tools will use to communicate with Odoo.
Output: A compilable TypeScript project with OdooClient (JSON-2 via native fetch) and OdooClientManager (LRU cache with TTL eviction).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-RESEARCH.md

Reference implementation (copy patterns from):
@/Users/nevilhulspas/Code/workflows/mcp/mrpeasy/src/lib/env.ts
@/Users/nevilhulspas/Code/workflows/mcp/mrpeasy/src/lib/logger.ts
@/Users/nevilhulspas/Code/workflows/mcp/mrpeasy/src/lib/errors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Project scaffolding and shared lib</name>
  <files>
    package.json
    tsconfig.json
    .env.example
    .gitignore
    src/lib/env.ts
    src/lib/logger.ts
    src/lib/errors.ts
  </files>
  <action>
    1. Create `package.json`:
       - name: "odoo-mcp", version: "0.1.0", type: "module"
       - main: "dist/server.js"
       - scripts: dev ("tsx watch src/server.ts"), build ("tsc"), start ("node dist/server.js"), typecheck ("tsc --noEmit")
       - dependencies: @modelcontextprotocol/sdk ^1.25.0, express ^4.21.0, zod ^3.25.0, lru-cache ^11.0.0, dotenv ^16.4.0
       - devDependencies: @types/express ^5.0.0, @types/node ^22.10.0, tsx ^4.19.2, typescript ^5.7.3
       - engines: { node: ">=20.0.0" }

    2. Create `tsconfig.json`:
       - target: "ES2022", module: "NodeNext", moduleResolution: "NodeNext"
       - outDir: "dist", rootDir: "src", strict: true, skipLibCheck: true
       - declaration: true, esModuleInterop: true, resolveJsonModule: true
       - include: ["src/**/*"]

    3. Create `.env.example` with all Phase 1 env vars:
       - PORT=3000
       - NODE_ENV=development
       - ODOO_URL=https://your-odoo-instance.odoo.com
       - ODOO_DATABASE=your-database-name
       - LOG_LEVEL=info

    4. Create `.gitignore`:
       - node_modules/, dist/, .env, *.tsbuildinfo

    5. Create `src/lib/logger.ts` - Copy the mrpeasy logger pattern exactly:
       - Writes ONLY to stderr (console.error) - NEVER console.log (corrupts MCP protocol)
       - Levels: debug, info, warn, error
       - Format: ISO timestamp + level + message + optional JSON data
       - Add LOG_LEVEL filtering: only emit if level >= configured level (error > warn > info > debug)

    6. Create `src/lib/env.ts` - Follow mrpeasy pattern but with Odoo env vars:
       - Zod schema for: ODOO_URL (string, url), ODOO_DATABASE (string, min 1), PORT (string->number, default 3000), NODE_ENV (enum, default development), LOG_LEVEL (enum debug|info|warn|error, default info)
       - Export validateEnv(), getEnv(), Env type
       - Fail fast with clear error messages listing all invalid vars
       - Load dotenv at the top: import 'dotenv/config'

    7. Create `src/lib/errors.ts` - Adapt mrpeasy errors for Odoo:
       - Keep McpToolError class exactly as mrpeasy (userMessage, internalDetails, isRetryable, suggestedAction, errorCode)
       - Add OdooApiError class: extends Error with statusCode, odooErrorName, odooDebug fields
       - Add helper: createOdooApiError(status, body) - maps Odoo error names to user-friendly messages:
         * "odoo.exceptions.AccessError" -> "You don't have permission to access this resource."
         * "odoo.exceptions.ValidationError" -> "Validation failed: {message}"
         * "odoo.exceptions.MissingError" -> "Record not found."
         * "odoo.exceptions.UserError" -> "{message}"
         * 401 -> "Your Odoo API key may have expired. Generate a new one in Odoo Settings > Security > API Keys."
         * 429 -> "Odoo rate limit exceeded. Try again in a few seconds."
       - Keep formatErrorForMcp, isRetryableHttpStatus from mrpeasy

    8. Run `npm install` to install all dependencies.

    9. Run `npx tsc --noEmit` to verify lib files compile without errors.
  </action>
  <verify>
    - `npm install` exits 0
    - `npx tsc --noEmit` exits 0 (no compile errors)
    - `node -e "import('./node_modules/@modelcontextprotocol/sdk/dist/esm/server/mcp.js')"` succeeds (SDK installed correctly)
  </verify>
  <done>
    Project compiles cleanly. All lib modules export their types. Dependencies installed. .env.example documents required config.
  </done>
</task>

<task type="auto">
  <name>Task 2: OdooClient and OdooClientManager</name>
  <files>
    src/services/odoo/types.ts
    src/services/odoo/client.ts
    src/services/odoo/client-manager.ts
  </files>
  <action>
    1. Create `src/services/odoo/types.ts`:
       - OdooSearchReadOptions: { limit?: number; offset?: number; order?: string; context?: Record<string, unknown> }
       - OdooErrorResponse: { name: string; message: string; arguments: unknown[]; context: Record<string, unknown>; debug?: string }
       - Export types for use by client.ts and future tool files

    2. Create `src/services/odoo/client.ts`:
       - Class OdooClient with constructor(baseUrl: string, apiKey: string, database: string)
       - Private readonly fields for all three params
       - Method `async call<T>(model: string, method: string, params: Record<string, unknown> = {}): Promise<T>`:
         * URL: `${this.baseUrl}/json/2/${model}/${method}`
         * Headers: Authorization: `bearer ${this.apiKey}`, Content-Type: application/json; charset=utf-8, X-Odoo-Database: this.database
         * Body: JSON.stringify(params)
         * On !response.ok: try JSON parse for OdooErrorResponse, throw OdooApiError with status + error details
         * On success: return response.json() as Promise<T>
       - Method `async searchRead<T>(model, domain, fields, options?)`:
         * Calls this.call<T[]>(model, 'search_read', { domain, fields, limit: options?.limit, offset: options?.offset, order: options?.order, context: options?.context ?? { lang: 'en_US' } })
       - Method `async read<T>(model, ids, fields)`:
         * Calls this.call<T[]>(model, 'read', { ids, fields, context: { lang: 'en_US' } })
       - Method `async searchCount(model, domain)`:
         * Calls this.call<number>(model, 'search_count', { domain })
       - Method `async create(model, vals)`:
         * Calls this.call<number>(model, 'create', vals)
       - Method `async write(model, ids, vals)`:
         * Calls this.call<boolean>(model, 'write', { ids, ...vals })
       - Method `async unlink(model, ids)`:
         * Calls this.call<boolean>(model, 'unlink', { ids })
       - IMPORTANT: Always pass context: { lang: 'en_US' } as default unless overridden (Pitfall 5 from research)

    3. Create `src/services/odoo/client-manager.ts`:
       - Import LRUCache from 'lru-cache'
       - Class OdooClientManager with constructor(odooUrl: string, odooDb: string, options?: { maxSize?: number; ttlMs?: number })
       - Private cache: LRUCache<string, OdooClient> with:
         * max: options.maxSize ?? 50
         * ttl: options.ttlMs ?? 30 * 60 * 1000 (30 minutes)
         * dispose callback: log eviction (truncate key to first 8 chars for safety)
       - Method `getClient(apiKey: string): OdooClient`:
         * Check cache.get(apiKey) - if hit, return it (LRU updates TTL automatically)
         * If miss: create new OdooClient(this.odooUrl, apiKey, this.odooDb), cache.set(), return
       - Getter `get size(): number` - returns cache.size
       - Method `clear(): void` - calls cache.clear() (for graceful shutdown)

    4. Run `npx tsc --noEmit` to verify everything compiles together.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `grep -r "new OdooClient" src/services/odoo/client-manager.ts` finds the instantiation
    - `grep -r "LRUCache" src/services/odoo/client-manager.ts` confirms LRU usage
    - `grep -r "bearer" src/services/odoo/client.ts` confirms auth header pattern
  </verify>
  <done>
    OdooClient wraps native fetch for JSON-2 API with bearer auth and typed responses. OdooClientManager provides LRU-cached per-user client instances with TTL eviction. Both compile cleanly with the shared lib types.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- All exports are correctly typed (Env, logger, McpToolError, OdooApiError, OdooClient, OdooClientManager)
- OdooClient.call() uses correct URL pattern: /json/2/{model}/{method}
- OdooClient.call() includes Authorization, Content-Type, and X-Odoo-Database headers
- OdooClientManager uses lru-cache with TTL and max size
- No console.log anywhere (only console.error via logger)
- .env.example documents all required environment variables
</verification>

<success_criteria>
1. `npm install && npx tsc --noEmit` exits 0
2. Project structure matches: src/lib/{env,logger,errors}.ts + src/services/odoo/{types,client,client-manager}.ts
3. OdooClient implements call, searchRead, read, searchCount, create, write, unlink
4. OdooClientManager caches by API key with max=50, TTL=30min
5. Error handling maps Odoo error names to user-friendly McpToolError instances
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
