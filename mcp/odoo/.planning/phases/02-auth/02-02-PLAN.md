---
phase: 02-auth
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/lib/env.ts
  - src/server.ts
  - src/mcp/index.ts
  - src/mcp/tools/test-odoo.ts
autonomous: true

must_haves:
  truths:
    - "mcpAuthRouter is mounted at app root creating all OAuth endpoints"
    - "requireBearerAuth protects POST/GET/DELETE /mcp endpoints"
    - "Login form POST validates Odoo credentials and redirects with auth code"
    - "MCP server factory no longer takes apiKey parameter"
    - "Tool handlers read API key from extra.authInfo.extra.odooApiKey"
    - "Environment requires ENCRYPTION_KEY and MCP_SERVER_URL"
    - "Health endpoint still returns session count and client count"
    - "x-odoo-api-key header is no longer used (removed)"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "Updated env schema with ENCRYPTION_KEY, MCP_SERVER_URL, DB_PATH"
      exports: ["validateEnv", "getEnv", "Env"]
    - path: "src/server.ts"
      provides: "Express app with mcpAuthRouter, requireBearerAuth, login endpoints, session management"
      min_lines: 150
    - path: "src/mcp/index.ts"
      provides: "createMcpServer factory without apiKey parameter"
      exports: ["createMcpServer"]
    - path: "src/mcp/tools/test-odoo.ts"
      provides: "Test tool using extra.authInfo for API key"
      exports: ["registerTestOdooTool"]
  key_links:
    - from: "src/server.ts"
      to: "src/auth/provider.ts"
      via: "OdooOAuthProvider instantiation and mcpAuthRouter({ provider })"
      pattern: "mcpAuthRouter"
    - from: "src/server.ts"
      to: "src/auth/credential-store.ts"
      via: "CredentialStore instantiation at startup"
      pattern: "new CredentialStore"
    - from: "src/server.ts"
      to: "src/auth/login-page.ts"
      via: "GET /login renders login page, POST /login validates credentials"
      pattern: "renderLoginPage"
    - from: "src/mcp/tools/test-odoo.ts"
      to: "extra.authInfo"
      via: "Tool handler reads extra.authInfo.extra.odooApiKey"
      pattern: "authInfo"
---

<objective>
Integrate OAuth 2.1 into the Express server, replacing the x-odoo-api-key header auth with proper OAuth flow using the SDK's mcpAuthRouter and requireBearerAuth.

Purpose: Wire the auth infrastructure (Plan 02-01) into the server, making MCP endpoints protected by bearer tokens that resolve to per-user Odoo API keys.
Output: A fully OAuth-protected MCP server where Claude clients can discover endpoints, register, authenticate, and make tool calls with proper user isolation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-auth/02-RESEARCH.md

Prior plan output (from Plan 02-01):
@src/auth/credential-store.ts
@src/auth/clients-store.ts
@src/auth/provider.ts
@src/auth/login-page.ts

Current files to modify:
@src/lib/env.ts
@src/server.ts
@src/mcp/index.ts
@src/mcp/tools/test-odoo.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update environment schema for OAuth</name>
  <files>
    src/lib/env.ts
  </files>
  <action>
    Update `src/lib/env.ts` to add new required environment variables:

    1. Add to envSchema:
       - ENCRYPTION_KEY: z.string({ required_error: 'ENCRYPTION_KEY is required' }).min(16, 'ENCRYPTION_KEY must be at least 16 characters')
       - MCP_SERVER_URL: z.string({ required_error: 'MCP_SERVER_URL is required' }).url('MCP_SERVER_URL must be a valid URL')
         * This is the public-facing URL of the MCP server (e.g., https://odoo-mcp.example.com/mcp)
       - DB_PATH: z.string().default('./data/credentials.db')
         * Path to the SQLite database file

    2. Update .env.example to include the new variables:
       ```
       # OAuth / Credential Store
       ENCRYPTION_KEY=generate-with-openssl-rand-base64-32
       MCP_SERVER_URL=https://your-mcp-server.example.com/mcp
       DB_PATH=./data/credentials.db
       ```

    3. Run `npx tsc --noEmit` to verify.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `grep "ENCRYPTION_KEY" src/lib/env.ts` confirms new env var
    - `grep "MCP_SERVER_URL" src/lib/env.ts` confirms new env var
    - `grep "DB_PATH" src/lib/env.ts` confirms new env var
  </verify>
  <done>
    Environment schema updated with ENCRYPTION_KEY, MCP_SERVER_URL, and DB_PATH. .env.example documents all new variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update MCP factory and tools for authInfo pattern</name>
  <files>
    src/mcp/index.ts
    src/mcp/tools/test-odoo.ts
  </files>
  <action>
    1. Update `src/mcp/index.ts`:
       - Remove apiKey parameter from createMcpServer
       - New signature: createMcpServer(clientManager: OdooClientManager): McpServer
       - Update registerTestOdooTool call to not pass apiKey
       - Keep registerPingTool as-is (no auth needed for ping)

    2. Update `src/mcp/tools/test-odoo.ts`:
       - Remove apiKey parameter from registerTestOdooTool
       - New signature: registerTestOdooTool(server: McpServer, clientManager: OdooClientManager): void
       - Update tool handler to use extra.authInfo:
         ```typescript
         async (params, extra) => {
           const authInfo = extra.authInfo;
           if (!authInfo?.extra?.odooApiKey) {
             return formatErrorForMcp(new McpToolError({
               userMessage: 'Not authenticated. Please reconnect to trigger OAuth login.',
               isRetryable: false,
               errorCode: 'AUTH_REQUIRED',
             }));
           }
           const odooApiKey = authInfo.extra.odooApiKey as string;
           const client = clientManager.getClient(odooApiKey);
           // ... rest of handler
         }
         ```

    3. Run `npx tsc --noEmit` to verify.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `grep "authInfo" src/mcp/tools/test-odoo.ts` confirms auth pattern
    - `grep "createMcpServer" src/mcp/index.ts | grep -v "apiKey"` confirms apiKey removed
  </verify>
  <done>
    MCP factory and tools updated to use authInfo.extra.odooApiKey pattern instead of passed apiKey. Unauthenticated tool calls return proper error.
  </done>
</task>

<task type="auto">
  <name>Task 3: Refactor server for OAuth integration</name>
  <files>
    src/server.ts
  </files>
  <action>
    Rewrite `src/server.ts` to use OAuth instead of header-based auth:

    1. New imports (add):
       - { mcpAuthRouter, getOAuthProtectedResourceMetadataUrl } from '@modelcontextprotocol/sdk/server/auth/router.js'
       - { requireBearerAuth } from '@modelcontextprotocol/sdk/server/auth/middleware/bearerAuth.js'
       - { AuthInfo } from '@modelcontextprotocol/sdk/server/auth/types.js'
       - { CredentialStore } from './auth/credential-store.js'
       - { OdooOAuthProvider } from './auth/provider.js'
       - { renderLoginPage } from './auth/login-page.js'
       - { mkdirSync } from 'fs'
       - { dirname } from 'path'

    2. After env validation, initialize auth infrastructure:
       - Ensure DB directory exists: mkdirSync(dirname(env.DB_PATH), { recursive: true })
       - const credentialStore = new CredentialStore({ dbPath: env.DB_PATH, masterKey: env.ENCRYPTION_KEY })
       - const oauthProvider = new OdooOAuthProvider(credentialStore, env.ODOO_URL, env.ODOO_DATABASE)
       - const mcpServerUrl = new URL(env.MCP_SERVER_URL)
       - const issuerUrl = new URL(mcpServerUrl.origin)

    3. Session store (update interface):
       - Remove apiKey field from SessionEntry (no longer needed per-session)
       - Keep: transport, server, lastActivity

    4. Express app setup:
       - app.use(express.json())
       - app.use(express.urlencoded({ extended: true }))  // For login form POST

    5. Mount mcpAuthRouter at app root (BEFORE other routes):
       ```typescript
       app.use(mcpAuthRouter({
         provider: oauthProvider,
         issuerUrl,
         baseUrl: issuerUrl,
         resourceServerUrl: mcpServerUrl,
         scopesSupported: [],
         resourceName: 'Odoo MCP Server',
         serviceDocumentationUrl: new URL('https://github.com/Natural-Heroes/workflows'),
       }));
       ```

    6. Login endpoints (placed AFTER mcpAuthRouter):
       - GET /login:
         * const pendingId = req.query.pending as string
         * if (!pendingId) return res.status(400).send('Missing pending authorization')
         * const pending = oauthProvider.getPendingAuth(pendingId)
         * if (!pending) return res.status(400).send('Invalid or expired authorization request')
         * res.type('html').send(renderLoginPage(pendingId))

       - POST /login:
         * const { pending, email, api_key } = req.body
         * if (!pending || !email || !api_key) return error
         * const pendingAuth = oauthProvider.getPendingAuth(pending)
         * if (!pendingAuth) return res.type('html').send(renderLoginPage(pending, 'Authorization request expired. Please try again.'))
         * Validate credentials: const userId = await oauthProvider.validateOdooCredentials(email, api_key)
         * if (!userId) return res.type('html').send(renderLoginPage(pending, 'Invalid credentials. Check your email and API key.'))
         * Store credentials: credentialStore.addOrUpdateUser(userId, api_key)
         * Complete authorization: const { redirectUri } = await oauthProvider.completeAuthorization(pending, userId)
         * res.redirect(redirectUri)

    7. Create bearer auth middleware:
       ```typescript
       const bearerAuth = requireBearerAuth({
         verifier: oauthProvider,
         requiredScopes: [],
         resourceMetadataUrl: getOAuthProtectedResourceMetadataUrl(mcpServerUrl),
       });
       ```

    8. Health endpoint (keep, no auth):
       - Return { status: 'healthy', version: '0.1.0', sessions: sessions.size, clients: clientManager.size }

    9. POST /mcp (rewrite with bearerAuth):
       - app.post('/mcp', bearerAuth, async (req, res) => { ... })
       - Remove apiKey extraction from headers
       - Session creation: createMcpServer(clientManager) â€” no apiKey param
       - The transport.handleRequest(req, res, req.body) will pass req.auth to tools as extra.authInfo
       - Keep session TTL touch logic

    10. GET /mcp (add bearerAuth):
        - app.get('/mcp', bearerAuth, async (req, res) => { ... })
        - Keep session validation and transport.handleRequest

    11. DELETE /mcp (add bearerAuth):
        - app.delete('/mcp', bearerAuth, async (req, res) => { ... })
        - Keep session cleanup

    12. Graceful shutdown (update):
        - Add credentialStore.close() to shutdown sequence

    13. Run `npx tsc --noEmit` to verify full project compiles.
  </action>
  <verify>
    - `npx tsc --noEmit` exits 0
    - `grep "mcpAuthRouter" src/server.ts` confirms OAuth router
    - `grep "requireBearerAuth" src/server.ts` confirms bearer middleware
    - `grep "x-odoo-api-key" src/server.ts` returns NOTHING (removed)
    - `grep "renderLoginPage" src/server.ts` confirms login form
    - `grep "credentialStore.close" src/server.ts` confirms shutdown cleanup
  </verify>
  <done>
    Server uses OAuth 2.1 via mcpAuthRouter + requireBearerAuth. Login form validates Odoo credentials. x-odoo-api-key header completely removed. Bearer tokens flow through to tool handlers as authInfo.extra.odooApiKey.
  </done>
</task>

<task type="auto">
  <name>Task 4: Smoke test</name>
  <files></files>
  <action>
    Verify the complete OAuth-protected system works:

    1. Create a temporary `.env` file:
       ```
       PORT=3000
       NODE_ENV=development
       ODOO_URL=https://naturalheroes-odoo.odoo.com
       ODOO_DATABASE=naturalheroes-odoo-main-18594498
       LOG_LEVEL=debug
       ENCRYPTION_KEY=test-encryption-key-for-development-only
       MCP_SERVER_URL=http://localhost:3000/mcp
       DB_PATH=./data/credentials.db
       ```

    2. Start the server in background: `npx tsx src/server.ts &`
       - Wait 2 seconds for startup

    3. Test health (no auth needed):
       - `curl -s http://localhost:3000/health`
       - Expected: { status: "healthy", ... }

    4. Test .well-known/oauth-authorization-server:
       - `curl -s http://localhost:3000/.well-known/oauth-authorization-server`
       - Expected: JSON with issuer, authorization_endpoint, token_endpoint, registration_endpoint

    5. Test .well-known/oauth-protected-resource (resource path):
       - `curl -s http://localhost:3000/.well-known/oauth-protected-resource`
       - Expected: JSON with resource, authorization_servers

    6. Test MCP endpoint without auth returns 401:
       - `curl -s -w "%{http_code}" -X POST http://localhost:3000/mcp -H "Content-Type: application/json" -d '{"jsonrpc":"2.0","id":1,"method":"initialize","params":{"protocolVersion":"2025-03-26","capabilities":{},"clientInfo":{"name":"test","version":"1.0"}}}'`
       - Expected: 401 status code

    7. Test dynamic client registration:
       - `curl -s -X POST http://localhost:3000/register -H "Content-Type: application/json" -d '{"client_name":"test-client","redirect_uris":["http://localhost:8080/callback"],"grant_types":["authorization_code"],"response_types":["code"],"token_endpoint_auth_method":"none"}'`
       - Expected: JSON with client_id

    8. Test /login page renders (GET):
       - First trigger authorize to get a pending ID (or just test with fake pending)
       - `curl -s http://localhost:3000/login?pending=test-pending-id`
       - Expected: HTML page (even if pending is invalid, should show error)

    9. Kill the server process.
    10. Remove the temporary .env and data/ directory.
    11. Build TypeScript: `npx tsc` (produces dist/)
    12. Verify dist/server.js exists: `node --check dist/server.js`

    NOTE: Do NOT test the full OAuth flow with real Odoo credentials. Smoke test only verifies endpoints exist and respond correctly.
  </action>
  <verify>
    - Health endpoint returns 200
    - .well-known/oauth-authorization-server returns valid JSON
    - POST /mcp without auth returns 401
    - /register returns client_id
    - /login renders HTML
    - `npx tsc` produces dist/server.js without errors
  </verify>
  <done>
    OAuth endpoints respond correctly. MCP endpoints reject unauthenticated requests. Login page renders. Project compiles to production-ready JavaScript. Phase 2 success criteria are verifiable.
  </done>
</task>

</tasks>

<verification>
Phase 2 success criteria mapping:
1. "Claude client discovers OAuth endpoints via .well-known metadata" -> mcpAuthRouter creates both metadata endpoints
2. "User authenticates with Odoo credentials during /authorize" -> authorize() redirects to /login, POST /login validates via Odoo API
3. "Access token resolves to correct Odoo API key" -> verifyAccessToken() reads from CredentialStore, returns in authInfo.extra
4. "Unauthorized requests rejected" -> requireBearerAuth returns 401 for missing/invalid/expired tokens

Additional checks:
- No x-odoo-api-key header anywhere (grep confirms)
- Token expiry in seconds since epoch (not milliseconds)
- Credential store uses AES-256-GCM
- No console.log in any file
- TypeScript compiles to dist/ without errors
</verification>

<success_criteria>
1. `curl http://localhost:3000/.well-known/oauth-authorization-server` returns valid OAuth metadata
2. `curl -X POST http://localhost:3000/mcp` without Bearer token returns 401
3. `curl -X POST http://localhost:3000/register` with valid metadata returns client_id
4. GET /login?pending=... renders HTML login form
5. POST /login with credentials stores encrypted API key and redirects with auth code
6. `npx tsc` produces valid dist/server.js
7. No references to x-odoo-api-key remain in the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth/02-02-SUMMARY.md`
</output>
