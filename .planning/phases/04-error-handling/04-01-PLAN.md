---
phase: 04-error-handling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/mrpeasy/src/lib/errors.ts
  - mcp/mrpeasy/src/services/mrpeasy/client.ts
  - mcp/mrpeasy/src/services/mrpeasy/index.ts
autonomous: true
---

<objective>
Create centralized error handling utilities with LLM-readable error messages and update the API client to use them.

Purpose: Provide consistent, actionable error responses that help LLMs understand what went wrong and how to recover. Separate user-facing messages from internal debugging details.
Output: Error utilities module and updated API client with enhanced error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-rate-limiting-resilience/03-02-SUMMARY.md

@mcp/mrpeasy/src/services/mrpeasy/client.ts
@mcp/mrpeasy/src/lib/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error utilities module</name>
  <files>mcp/mrpeasy/src/lib/errors.ts</files>
  <action>
Create a centralized error handling module with:

1. `McpToolError` class extending Error:
   ```typescript
   export class McpToolError extends Error {
     public readonly userMessage: string;      // LLM-friendly message
     public readonly internalDetails?: string; // Debug info (logged, not returned)
     public readonly isRetryable: boolean;     // Whether LLM should retry
     public readonly suggestedAction?: string; // What the LLM can do
     public readonly errorCode?: string;       // Machine-readable code
   }
   ```

2. Factory functions for common error types:
   - `createRateLimitError(retryAfterSeconds?: number)` → McpToolError with "Rate limited. Try again in X seconds." message
   - `createServiceUnavailableError()` → McpToolError with "Service temporarily unavailable. Try again later." message
   - `createAuthenticationError()` → McpToolError with "Authentication failed. Check API credentials." message
   - `createNotFoundError(resource: string)` → McpToolError with "X not found." message
   - `createValidationError(field: string, issue: string)` → McpToolError for input validation failures
   - `createUnexpectedError(error: unknown)` → McpToolError for unknown errors (wraps, logs internal details)

3. `formatErrorForMcp(error: McpToolError)` function that returns MCP-compatible response:
   ```typescript
   return {
     content: [{ type: 'text', text: error.userMessage + (error.suggestedAction ? `\n\nSuggestion: ${error.suggestedAction}` : '') }],
     isError: true,
   };
   ```

4. `isRetryableHttpStatus(status: number)` helper → true for 429, 503, 408, 502, 504

All error messages should be:
- Complete sentences
- Actionable (tell LLM what to do)
- No technical jargon (no stack traces, no internal codes)
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>McpToolError class and factory functions exported from lib/errors.ts</done>
</task>

<task type="auto">
  <name>Task 2: Update API client error handling</name>
  <files>mcp/mrpeasy/src/services/mrpeasy/client.ts</files>
  <action>
Update MrpEasyApiError and client error handling:

1. Enhance MrpEasyApiError to include retry guidance:
   ```typescript
   export class MrpEasyApiError extends Error {
     public readonly status: number;
     public readonly code?: string;
     public readonly isRetryable: boolean;
     public readonly retryAfterSeconds?: number;

     constructor(message: string, status: number, code?: string, retryAfterSeconds?: number) {
       super(message);
       this.name = 'MrpEasyApiError';
       this.status = status;
       this.code = code;
       this.isRetryable = [429, 503, 408, 502, 504].includes(status);
       this.retryAfterSeconds = retryAfterSeconds;
     }
   }
   ```

2. In `executeRequest`, extract Retry-After header for 429 responses:
   ```typescript
   if (response.status === 429) {
     const retryAfter = response.headers.get('Retry-After');
     const retrySeconds = retryAfter ? parseInt(retryAfter, 10) : undefined;
     throw new MrpEasyApiError(
       'Rate limit exceeded',
       429,
       'RATE_LIMITED',
       retrySeconds
     );
   }
   ```

3. Handle 503 with appropriate message:
   ```typescript
   if (response.status === 503) {
     throw new MrpEasyApiError(
       'MRPeasy service is temporarily unavailable',
       503,
       'SERVICE_UNAVAILABLE'
     );
   }
   ```

4. Handle 401/403 with clear auth error:
   ```typescript
   if (response.status === 401 || response.status === 403) {
     throw new MrpEasyApiError(
       'Authentication failed. Check MRPEASY_API_KEY and MRPEASY_API_SECRET.',
       response.status,
       'AUTH_ERROR'
     );
   }
   ```

5. Handle 404 with resource not found:
   ```typescript
   if (response.status === 404) {
     throw new MrpEasyApiError(
       'Resource not found',
       404,
       'NOT_FOUND'
     );
   }
   ```

Keep existing resilience stack unchanged (queue → circuit breaker → retry → rate limiter → fetch).
  </action>
  <verify>npm run typecheck passes</verify>
  <done>MrpEasyApiError has isRetryable and retryAfterSeconds, client extracts Retry-After header</done>
</task>

<task type="auto">
  <name>Task 3: Update module exports</name>
  <files>mcp/mrpeasy/src/services/mrpeasy/index.ts</files>
  <action>
Ensure MrpEasyApiError with new properties is properly exported.

No changes needed to index.ts if it already re-exports MrpEasyApiError from client.ts (verify this is the case).

Also export error utilities from the main lib:
- Create or update `mcp/mrpeasy/src/lib/index.ts` to export from errors.ts:
  ```typescript
  export * from './errors.js';
  export * from './logger.js';
  export * from './env.js';
  ```
  </action>
  <verify>npm run typecheck passes</verify>
  <done>All error utilities and enhanced MrpEasyApiError exported</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run typecheck` passes
- [ ] McpToolError class created with userMessage, internalDetails, isRetryable, suggestedAction
- [ ] Factory functions for rate limit, service unavailable, auth, not found, validation, unexpected errors
- [ ] MrpEasyApiError has isRetryable and retryAfterSeconds properties
- [ ] Client extracts Retry-After header from 429 responses
- [ ] All exports available from module indexes
</verification>

<success_criteria>
- All tasks completed
- TypeScript compiles without errors
- Error utilities provide LLM-friendly messages
- API client handles 429/503 with retry guidance
- Foundation ready for tool integration in plan 04-02
</success_criteria>

<output>
After completion, create `.planning/phases/04-error-handling/04-01-SUMMARY.md`
</output>
