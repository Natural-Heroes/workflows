---
phase: 02-stock-analytics-completion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/inventory-planner/package.json
  - mcp/inventory-planner/src/mcp/tools/variants.test.ts
autonomous: true

must_haves:
  truths:
    - "get_variants tool returns variants matching SKU filter"
    - "get_variants tool returns variants at stockout risk when oos_lt filter applied"
    - "get_replenishment tool returns only items with replenishment > 0"
    - "get_variants tool returns inventory_value for value breakdowns"
    - "get_variant tool returns forecast data (daily, weekly, monthly)"
    - "Tools return LLM-friendly error messages on API failures"
  artifacts:
    - path: "mcp/inventory-planner/src/mcp/tools/variants.test.ts"
      provides: "Integration tests for variant tools (get_variants, get_variant, get_replenishment)"
      min_lines: 200
  key_links:
    - from: "variants.test.ts"
      to: "variants.ts"
      via: "MCP tool invocation through supertest"
      pattern: "callTool.*get_variants|get_variant|get_replenishment"
    - from: "variants.test.ts"
      to: "vitest-fetch-mock"
      via: "API response mocking"
      pattern: "fetchMocker\\.mockResponseOnce"
---

<objective>
Validate existing variant tools (get_variants, get_variant, get_replenishment) with integration tests that mock the Inventory Planner API.

Purpose: Verify READ-01 through READ-05 requirements are satisfied by existing tool implementations
Output: variants.test.ts with comprehensive test coverage for stock levels, stockout risk, replenishment, inventory value, and forecasts
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stock-analytics-completion/02-RESEARCH.md

# Existing test patterns
@mcp/inventory-planner/src/__tests__/mcp-session.test.ts

# Tools to test
@mcp/inventory-planner/src/mcp/tools/variants.ts

# Client reset for test isolation
@mcp/inventory-planner/src/services/inventory-planner/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vitest-fetch-mock</name>
  <files>mcp/inventory-planner/package.json</files>
  <action>
Install vitest-fetch-mock as a dev dependency for mocking fetch calls in tests:

```bash
cd mcp/inventory-planner && npm install -D vitest-fetch-mock
```

This package provides clean fetch mocking that integrates with vitest, replacing the need to manually mock global.fetch.
  </action>
  <verify>
cd mcp/inventory-planner && npm ls vitest-fetch-mock
cd mcp/inventory-planner && grep vitest-fetch-mock package.json
  </verify>
  <done>vitest-fetch-mock added to devDependencies in package.json</done>
</task>

<task type="auto">
  <name>Task 2: Create variants.test.ts with comprehensive tool tests</name>
  <files>mcp/inventory-planner/src/mcp/tools/variants.test.ts</files>
  <action>
Create integration tests for the three variant tools covering all READ requirements.

**Test file structure:**
```typescript
// Set fake environment variables before importing app
process.env.INVENTORY_PLANNER_API_KEY = 'test-key';
process.env.INVENTORY_PLANNER_ACCOUNT_ID = 'test-account';

import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import createFetchMock from 'vitest-fetch-mock';
import request from 'supertest';
import { app, transports } from '../../app.js';
import { resetInventoryPlannerClient } from '../../services/inventory-planner/index.js';

const fetchMocker = createFetchMock(vi);
const MCP_ACCEPT_HEADER = 'application/json, text/event-stream';
```

**Helper functions (copy patterns from mcp-session.test.ts):**
- `parseSSEResponse(text)` - Extract JSON from SSE data lines
- `initializeSession()` - Initialize MCP session, return sessionId
- `callTool(sessionId, toolName, args)` - Invoke tool, parse response, return result object

**Test suites needed:**

1. **get_variants tool (READ-01, READ-02, READ-04)**
   - Returns variants with stock metrics (stockOnHand, stockAvailable, stockIncoming)
   - Filters by SKU parameter (READ-01)
   - Filters by warehouse_id parameter
   - Filters by vendor_id parameter
   - Filters by stock_on_hand_lt parameter (low stock)
   - Filters by oos_lt parameter for stockout risk (READ-02)
   - Returns inventory_value for value breakdowns (READ-04)
   - Handles empty results (returns summary with 0 variants)
   - Returns pagination metadata (showing, total, page, limit)
   - Returns LLM-friendly error on API failure

2. **get_variant tool (READ-01, READ-05)**
   - Returns single variant with full metrics
   - Returns stock object (onHand, available, incoming, reserved)
   - Returns replenishment metrics (quantity, daysUntilOOS, daysOfStock)
   - Returns forecast data (daily, weekly, monthly, velocityDaily) (READ-05)
   - Returns financial data (avgCost, price, inventoryValue)
   - Returns classification (warehouse, vendor, abcClass)
   - Returns LLM-friendly error for not found (404)

3. **get_replenishment tool (READ-03)**
   - Returns only items with replenishment > 0
   - Filters by warehouse_id
   - Filters by vendor_id
   - Returns replenishment quantities and urgency (daysUntilOOS)
   - Calculates urgent count (oos < 7 days)
   - Handles empty results
   - Returns LLM-friendly error on API failure

**Mock API response patterns:**

For get_variants:
```typescript
fetchMocker.mockResponseOnce(JSON.stringify({
  result: { status: 'success' },
  meta: { name: 'variants', total: 1, count: 1, limit: 100 },
  variants: [{
    id: 'v1',
    sku: 'TEST-SKU-001',
    title: 'Test Product',
    stock_on_hand: 100,
    stock_available: 90,
    stock_incoming: 20,
    replenishment: 50,
    oos: 14,
    days_of_stock: 30,
    inventory_value: 1500.00,
    vendor_name: 'Acme Corp',
    warehouse_name: 'Main Warehouse',
    forecast_daily: 3.0,
    forecast_weekly: 21.0,
    forecast_monthly: 90.0,
  }],
}));
```

For get_variant (single):
```typescript
fetchMocker.mockResponseOnce(JSON.stringify({
  result: { status: 'success' },
  variant: {
    id: 'v1',
    sku: 'TEST-SKU-001',
    title: 'Test Product',
    full_title: 'Test Product - Size M',
    product_id: 'p1',
    stock_on_hand: 100,
    stock_available: 90,
    stock_incoming: 20,
    stock_reserved: 10,
    replenishment: 50,
    oos: 14,
    days_of_stock: 30,
    reorder_point: 25,
    safety_stock: 10,
    lead_time: 7,
    review_period: 14,
    forecast_daily: 3.0,
    forecast_weekly: 21.0,
    forecast_monthly: 90.0,
    velocity_daily: 2.8,
    velocity_weekly: 19.6,
    avg_cost: 15.00,
    price: 29.99,
    inventory_value: 1500.00,
    under_value: 0,
    over_value: 200.00,
    vendor_id: 'vendor-1',
    vendor_name: 'Acme Corp',
    warehouse_id: 'wh-1',
    warehouse_name: 'Main Warehouse',
    product_type: 'Widgets',
    abc_class: 'A',
    xyz_class: 'X',
    tags: ['bestseller'],
    active: true,
    updated_at: '2026-01-25T12:00:00Z',
  },
}));
```

**Important patterns:**
- Use `beforeEach` to enable mocks, reset mocks, clear transports, reset client
- Use `afterEach` to disable mocks
- Call `resetInventoryPlannerClient()` to ensure fresh client per test (prevents stale mocks)
- Parse tool response content[0].text as JSON to get result object
- Test both success and error scenarios
  </action>
  <verify>
Run tests: `cd mcp/inventory-planner && npm test`
All new tests pass.
Coverage includes:
- get_variants: filtering, pagination, empty results, errors
- get_variant: full metrics, forecasts, not found
- get_replenishment: filtering, urgency calculation, errors
  </verify>
  <done>
variants.test.ts created with tests covering:
- READ-01: Stock levels by SKU/filters (get_variants, get_variant)
- READ-02: Stockout risk filtering (get_variants with oos_lt)
- READ-03: Replenishment recommendations (get_replenishment)
- READ-04: Inventory value breakdowns (get_variants returns inventory_value)
- READ-05: Demand forecasts (get_variant returns forecast data)
All tests pass.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. **Test suite passes:**
   ```bash
   cd mcp/inventory-planner && npm test
   ```
   All tests pass including new variants.test.ts

2. **Coverage check:**
   - get_variants: 8+ tests covering filtering, pagination, metrics, errors
   - get_variant: 4+ tests covering full response, forecasts, not found
   - get_replenishment: 4+ tests covering filtering, urgency, errors

3. **Build succeeds:**
   ```bash
   cd mcp/inventory-planner && npm run build
   ```

4. **Requirement verification:**
   - READ-01: Tests verify SKU filtering and stock levels returned
   - READ-02: Tests verify oos_lt filtering for stockout risk
   - READ-03: Tests verify replenishment tool returns items needing reorder
   - READ-04: Tests verify inventory_value returned in variants
   - READ-05: Tests verify forecast_daily/weekly/monthly in get_variant
</verification>

<success_criteria>
- vitest-fetch-mock installed in devDependencies
- variants.test.ts exists with 15+ tests
- All tests pass (`npm test` exits 0)
- Tests cover READ-01 through READ-05 requirements
- Both success and error scenarios tested
- Build succeeds (`npm run build` exits 0)
</success_criteria>

<output>
After completion, create `.planning/phases/02-stock-analytics-completion/02-01-SUMMARY.md`
</output>
