---
phase: 01-foundation-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/inventory-planner/package.json
  - mcp/inventory-planner/vitest.config.ts
  - mcp/inventory-planner/src/app.ts
  - mcp/inventory-planner/src/server.ts
  - mcp/inventory-planner/src/lib/env.test.ts
  - mcp/inventory-planner/src/services/inventory-planner/circuit-breaker.test.ts
  - mcp/inventory-planner/src/services/inventory-planner/rate-limiter.test.ts
  - mcp/inventory-planner/src/services/inventory-planner/retry.test.ts
  - mcp/inventory-planner/src/services/inventory-planner/request-queue.test.ts
autonomous: true

must_haves:
  truths:
    - "Server validates environment variables at startup and fails fast with clear error on missing config"
    - "Rate limiter allows burst up to capacity and refills tokens over time"
    - "Circuit breaker opens after threshold failures and transitions through HALF_OPEN back to CLOSED"
    - "Retry logic respects Retry-After headers and uses exponential backoff"
    - "Request queue processes requests FIFO with single concurrency"
  artifacts:
    - path: "mcp/inventory-planner/vitest.config.ts"
      provides: "Test runner configuration"
    - path: "mcp/inventory-planner/src/app.ts"
      provides: "Express app export for testability"
      exports: ["app", "transports"]
    - path: "mcp/inventory-planner/src/lib/env.test.ts"
      provides: "Environment validation tests"
      min_lines: 30
    - path: "mcp/inventory-planner/src/services/inventory-planner/circuit-breaker.test.ts"
      provides: "Circuit breaker tests"
      min_lines: 50
    - path: "mcp/inventory-planner/src/services/inventory-planner/rate-limiter.test.ts"
      provides: "Rate limiter tests"
      min_lines: 30
    - path: "mcp/inventory-planner/src/services/inventory-planner/retry.test.ts"
      provides: "Retry logic tests"
      min_lines: 30
    - path: "mcp/inventory-planner/src/services/inventory-planner/request-queue.test.ts"
      provides: "Request queue tests"
      min_lines: 30
  key_links:
    - from: "mcp/inventory-planner/src/server.ts"
      to: "mcp/inventory-planner/src/app.ts"
      via: "import { app } from './app.js'"
      pattern: "import.*app.*from.*app"
    - from: "mcp/inventory-planner/vitest.config.ts"
      to: "package.json test script"
      via: "vitest configured as test runner"
      pattern: "vitest"
---

<objective>
Setup test infrastructure and validate core resilience components (INFRA-01, INFRA-02).

Purpose: Establish testing foundation and prove that environment validation and all resilience components (rate limiter, circuit breaker, retry, request queue) work correctly in isolation.

Output:
- vitest configured with proper TypeScript/ESM support
- Express app extracted to app.ts for testability
- Unit tests for env.ts covering fail-fast behavior
- Unit tests for all resilience components (circuit-breaker, rate-limiter, retry, request-queue)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-validation/01-RESEARCH.md

@mcp/inventory-planner/package.json
@mcp/inventory-planner/src/server.ts
@mcp/inventory-planner/src/lib/env.ts
@mcp/inventory-planner/src/services/inventory-planner/circuit-breaker.ts
@mcp/inventory-planner/src/services/inventory-planner/rate-limiter.ts
@mcp/inventory-planner/src/services/inventory-planner/retry.ts
@mcp/inventory-planner/src/services/inventory-planner/request-queue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Setup test infrastructure and refactor for testability</name>
  <files>
    mcp/inventory-planner/package.json
    mcp/inventory-planner/vitest.config.ts
    mcp/inventory-planner/src/app.ts
    mcp/inventory-planner/src/server.ts
  </files>
  <action>
    1. Install test dependencies:
       ```bash
       cd mcp/inventory-planner && npm install -D vitest supertest @types/supertest
       ```

    2. Create vitest.config.ts with ESM and TypeScript support:
       - Set test environment to 'node'
       - Include src/**/*.test.ts pattern
       - Configure coverage (optional but recommended)

    3. Add test scripts to package.json:
       - "test": "vitest run"
       - "test:watch": "vitest"
       - "test:coverage": "vitest run --coverage"

    4. Extract Express app to src/app.ts for testability:
       - Move Express app creation, middleware, routes, and transports Map to app.ts
       - Export `app` and `transports` (transports needed for test cleanup)
       - Keep environment validation in server.ts (validates at startup)
       - server.ts becomes thin: imports app, validates env, calls app.listen()

    Note: The app/server separation is required because supertest needs the Express app without starting a real listener.
  </action>
  <verify>
    - `npm test` runs (may have no tests yet, should not error)
    - `npm run build` still succeeds
    - TypeScript compiles without errors
    - Server still starts with `npm run dev`
  </verify>
  <done>
    - vitest.config.ts exists with proper ESM/TS configuration
    - package.json has test, test:watch scripts
    - src/app.ts exports Express app and transports Map
    - src/server.ts imports from app.ts and only handles startup
    - All existing functionality preserved
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for environment validation (INFRA-01)</name>
  <files>
    mcp/inventory-planner/src/lib/env.test.ts
  </files>
  <action>
    Create env.test.ts co-located with env.ts. Test cases:

    1. **Missing required vars:**
       - Throws when INVENTORY_PLANNER_API_KEY is missing
       - Throws when INVENTORY_PLANNER_ACCOUNT_ID is missing
       - Error message includes the missing variable name

    2. **Empty values rejected:**
       - Throws when API key is empty string
       - Throws when account ID is empty string

    3. **Valid environment with defaults:**
       - Accepts valid API_KEY and ACCOUNT_ID
       - PORT defaults to 3000
       - NODE_ENV defaults to 'development'

    4. **Invalid PORT:**
       - Throws when PORT is not a number
       - Throws when PORT is out of range (0, 65536+)

    5. **Valid NODE_ENV values:**
       - Accepts 'development', 'production', 'test'
       - Rejects invalid values like 'staging'

    Pattern for env isolation (from research):
    ```typescript
    const originalEnv = process.env;
    beforeEach(() => {
      vi.resetModules();
      process.env = { ...originalEnv };
    });
    afterEach(() => {
      process.env = originalEnv;
    });
    ```

    Use dynamic import to re-evaluate env.ts after changing process.env.
  </action>
  <verify>
    `npm test -- src/lib/env.test.ts` passes with all test cases green
  </verify>
  <done>
    - env.test.ts exists with 8+ test cases covering INFRA-01 requirements
    - Tests verify fail-fast behavior with clear error messages
    - Tests verify defaults are applied correctly
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Unit tests for resilience components (INFRA-02)</name>
  <files>
    mcp/inventory-planner/src/services/inventory-planner/circuit-breaker.test.ts
    mcp/inventory-planner/src/services/inventory-planner/rate-limiter.test.ts
    mcp/inventory-planner/src/services/inventory-planner/retry.test.ts
    mcp/inventory-planner/src/services/inventory-planner/request-queue.test.ts
  </files>
  <action>
    Create co-located test files for each resilience component:

    **circuit-breaker.test.ts:**
    - Starts in CLOSED state
    - Allows requests in CLOSED state
    - Opens after failureThreshold consecutive failures
    - Blocks requests when OPEN (throws CircuitBreakerOpenError)
    - Transitions to HALF_OPEN after timeout (use vi.useFakeTimers)
    - Returns to CLOSED after successThreshold successes in HALF_OPEN
    - Returns to OPEN on failure in HALF_OPEN
    - shouldTrip predicate: 4xx errors don't trip, 5xx errors do
    - reset() returns to CLOSED state

    **rate-limiter.test.ts:**
    - Allows burst up to capacity
    - Rejects when tokens exhausted
    - Refills tokens over time (use vi.useFakeTimers)
    - waitForToken blocks until token available
    - getTokenCount returns current count

    **retry.test.ts:**
    - Returns result on first success (no retry needed)
    - Retries on 429 status
    - Retries on 503 status
    - Does NOT retry on 400/401/404 (non-retryable)
    - Respects Retry-After header for 429
    - Uses exponential backoff (use vi.useFakeTimers to verify delays)
    - Throws after maxAttempts exhausted
    - Note: Mock InventoryPlannerApiError for these tests

    **request-queue.test.ts:**
    - Processes requests in FIFO order
    - Processes only one request at a time (single concurrency)
    - getQueueDepth returns correct count
    - isProcessing returns true during execution
    - Handles errors without breaking queue

    Use vi.useFakeTimers() for all time-dependent tests to avoid flaky tests and slow execution.
  </action>
  <verify>
    ```bash
    npm test -- src/services/inventory-planner/
    ```
    All resilience component tests pass.
  </verify>
  <done>
    - circuit-breaker.test.ts covers all state transitions and shouldTrip predicate
    - rate-limiter.test.ts covers burst, refill, and waiting
    - retry.test.ts covers retryable/non-retryable errors, backoff, Retry-After
    - request-queue.test.ts covers FIFO ordering and single concurrency
    - All tests pass with `npm test`
  </done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
cd mcp/inventory-planner && npm test
```

Expected: All tests pass covering INFRA-01 (env validation) and INFRA-02 (resilience stack).

Verify build still works:
```bash
cd mcp/inventory-planner && npm run build
```

Verify server starts:
```bash
cd mcp/inventory-planner && npm run dev
# Ctrl+C after seeing startup message
```
</verification>

<success_criteria>
1. Test infrastructure established (vitest configured, scripts in package.json)
2. Express app extracted to app.ts for testability
3. env.test.ts validates fail-fast behavior with clear errors (INFRA-01)
4. circuit-breaker.test.ts validates all state transitions
5. rate-limiter.test.ts validates token bucket behavior
6. retry.test.ts validates exponential backoff and Retry-After handling
7. request-queue.test.ts validates FIFO and single concurrency
8. `npm test` passes with all tests green
9. Server still builds and runs correctly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-01-SUMMARY.md`
</output>
