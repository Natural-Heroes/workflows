---
phase: 01-foundation-validation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - mcp/inventory-planner/src/mcp/tools/error-handler.test.ts
  - mcp/inventory-planner/src/__tests__/mcp-session.test.ts
autonomous: true

must_haves:
  truths:
    - "API errors return LLM-friendly messages with actionable suggestions"
    - "429 errors include retry timing guidance"
    - "401/403 errors suggest checking API credentials"
    - "Circuit breaker open returns service unavailable message"
    - "Unknown errors return generic message without exposing internals"
    - "MCP client can initialize a session and receive session ID"
    - "MCP client can invoke tools after session initialization"
    - "MCP client maintains session across multiple requests"
    - "Invalid session ID returns clear error"
    - "Missing session ID for non-initialize requests returns clear error"
  artifacts:
    - path: "mcp/inventory-planner/src/mcp/tools/error-handler.test.ts"
      provides: "Error translation tests"
      min_lines: 40
    - path: "mcp/inventory-planner/src/__tests__/mcp-session.test.ts"
      provides: "MCP session integration tests"
      min_lines: 60
  key_links:
    - from: "mcp/inventory-planner/src/__tests__/mcp-session.test.ts"
      to: "mcp/inventory-planner/src/app.ts"
      via: "supertest import of Express app"
      pattern: "import.*app.*from.*app"
    - from: "mcp/inventory-planner/src/mcp/tools/error-handler.test.ts"
      to: "mcp/inventory-planner/src/mcp/tools/error-handler.ts"
      via: "import handleToolError"
      pattern: "import.*handleToolError"
---

<objective>
Validate error handling (INFRA-03) and MCP session protocol (INFRA-04).

Purpose: Prove that API errors are translated to LLM-friendly messages with actionable suggestions, and that MCP clients can establish and maintain sessions correctly.

Output:
- Unit tests for error-handler.ts covering all error type translations
- Integration tests for MCP session flow using supertest
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-validation/01-RESEARCH.md
@.planning/phases/01-foundation-validation/01-01-SUMMARY.md

@mcp/inventory-planner/src/app.ts
@mcp/inventory-planner/src/mcp/tools/error-handler.ts
@mcp/inventory-planner/src/lib/errors.ts
@mcp/inventory-planner/src/services/inventory-planner/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for error translation (INFRA-03)</name>
  <files>
    mcp/inventory-planner/src/mcp/tools/error-handler.test.ts
  </files>
  <action>
    Create error-handler.test.ts co-located with error-handler.ts. Test cases:

    **Rate limit errors (429):**
    - Returns isError: true
    - Message includes "Rate limit exceeded"
    - Includes retry timing when retryAfterSeconds provided
    - Includes generic "few seconds" when no retry timing

    **Authentication errors (401, 403):**
    - Returns isError: true
    - Message mentions "Authentication failed"
    - Suggests checking INVENTORY_PLANNER_API_KEY

    **Not found errors (404):**
    - Returns isError: true
    - Message includes "not found"
    - Suggests verifying ID or search criteria

    **Service unavailable (503):**
    - Returns isError: true
    - Message indicates temporary unavailability
    - Suggests retry

    **API validation errors (400):**
    - Returns isError: true
    - Passes through the API error message
    - Suggests checking request parameters

    **Circuit breaker open:**
    - Returns isError: true
    - Message indicates service temporarily unavailable
    - Does NOT expose "circuit breaker" terminology to LLM

    **Unknown/unexpected errors:**
    - Returns isError: true
    - Returns generic message
    - Does NOT expose internal error details to LLM
    - Internal details logged but not returned

    Import InventoryPlannerApiError from client.ts and CircuitBreakerOpenError from circuit-breaker.ts for creating test errors.
  </action>
  <verify>
    `npm test -- src/mcp/tools/error-handler.test.ts` passes with all test cases green
  </verify>
  <done>
    - error-handler.test.ts exists with 10+ test cases
    - All HTTP status codes properly translated to LLM-friendly messages
    - CircuitBreakerOpenError handled correctly
    - Unknown errors don't leak internal details
    - All tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for MCP session protocol (INFRA-04)</name>
  <files>
    mcp/inventory-planner/src/__tests__/mcp-session.test.ts
  </files>
  <action>
    Create __tests__ directory and mcp-session.test.ts for integration tests using supertest.

    **Session initialization:**
    - POST /mcp with initialize request returns 200
    - Response includes mcp-session-id header
    - Response body contains protocolVersion and serverInfo

    **Session rejection:**
    - POST /mcp without session ID for non-initialize request returns 400
    - Error message mentions "Missing mcp-session-id header"
    - POST /mcp with invalid session ID returns 400
    - Error message mentions "Invalid session ID"

    **Session maintenance:**
    - Initialize session, then use session ID for tools/list
    - tools/list returns array of available tools
    - Multiple requests with same session ID work

    **Tool invocation:**
    - Initialize session
    - Call ping tool (exists in codebase)
    - Response contains "pong"

    **Health endpoint (bonus):**
    - GET /health returns 200
    - Response includes status: "healthy"
    - Response includes sessions count

    Setup pattern:
    ```typescript
    import request from 'supertest';
    import { app, transports } from '../app.js';

    beforeEach(() => {
      transports.clear(); // Reset sessions between tests
    });
    ```

    Note: These tests require the app.ts refactor from Plan 01 to import the Express app without starting a listener.

    Important: Set fake environment variables before importing app to avoid env validation errors:
    ```typescript
    process.env.INVENTORY_PLANNER_API_KEY = 'test-key';
    process.env.INVENTORY_PLANNER_ACCOUNT_ID = 'test-account';
    ```
  </action>
  <verify>
    `npm test -- src/__tests__/mcp-session.test.ts` passes with all test cases green
  </verify>
  <done>
    - __tests__/mcp-session.test.ts exists with 8+ test cases
    - Session initialization tested
    - Session rejection (missing/invalid ID) tested
    - Session persistence across requests tested
    - Tool invocation (ping) tested
    - Health endpoint tested
    - All tests pass
  </done>
</task>

</tasks>

<verification>
Run the full test suite:
```bash
cd mcp/inventory-planner && npm test
```

Expected: All tests pass covering INFRA-01, INFRA-02, INFRA-03, and INFRA-04.

Check test coverage:
```bash
cd mcp/inventory-planner && npm test -- --coverage
```

Summary of what's validated:
- INFRA-01: Environment validation (env.test.ts)
- INFRA-02: Resilience stack (circuit-breaker, rate-limiter, retry, request-queue tests)
- INFRA-03: Error translation (error-handler.test.ts)
- INFRA-04: MCP sessions (mcp-session.test.ts)
</verification>

<success_criteria>
1. error-handler.test.ts validates LLM-friendly error messages (INFRA-03)
2. All error types return actionable suggestions
3. Unknown errors don't expose internal details
4. mcp-session.test.ts validates session protocol (INFRA-04)
5. Session initialization returns session ID
6. Sessions maintained across multiple requests
7. Invalid/missing session IDs rejected with clear errors
8. Tool invocation works within session
9. `npm test` passes with all tests green
10. Foundation validation phase complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-validation/01-02-SUMMARY.md`
</output>
