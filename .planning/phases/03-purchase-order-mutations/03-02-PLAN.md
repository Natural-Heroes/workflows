---
phase: 03-purchase-order-mutations
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/inventory-planner/src/mcp/tools/mutations.test.ts
autonomous: true

must_haves:
  truths:
    - "User can update variant planning parameters (lead time, review period, safety stock)"
    - "Preview mode shows proposed changes without executing"
    - "Confirm mode applies changes and returns updated variant"
  artifacts:
    - path: "mcp/inventory-planner/src/mcp/tools/mutations.test.ts"
      provides: "Integration tests for update_variant tool"
      min_lines: 150
  key_links:
    - from: "mutations.test.ts"
      to: "mutations.ts"
      via: "MCP tool calls through supertest"
      pattern: "callTool.*update_variant"
---

<objective>
Validate the update_variant mutation tool with comprehensive integration tests covering preview mode, confirmation mode, all updatable fields, and error handling.

Purpose: Verify VAR-01 requirement is met - user can update planning parameters (lead time, review period, safety stock, reorder point, active status).

Output: mutations.test.ts with ~10-12 tests covering the update_variant tool.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stock-analytics-completion/02-01-SUMMARY.md

# Source file to test
@mcp/inventory-planner/src/mcp/tools/mutations.ts

# Test patterns to follow
@mcp/inventory-planner/src/mcp/tools/variants.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mutations.test.ts with update_variant tests</name>
  <files>mcp/inventory-planner/src/mcp/tools/mutations.test.ts</files>
  <action>
Create integration tests for the update_variant tool.

Follow the EXACT test patterns from variants.test.ts:
1. Same imports (vitest, vitest-fetch-mock, supertest)
2. Same environment variable setup at top of file
3. Same parseSSEResponse, initializeSession, callTool helper functions
4. Same beforeEach/afterEach setup with fetchMocker

Tests for update_variant (VAR-01):

Preview mode tests:
- Preview mode (confirm=false) returns preview object without API call
- Preview shows all proposed updates (id, lead_time, review_period, etc.)
- Verify NO fetch was called during preview

Confirm mode tests:
- Confirm mode (confirm=true) updates variant and returns success
- Can update lead_time
- Can update review_period
- Can update safety_stock
- Can update reorder_point
- Can update active status
- Can update multiple fields at once

Error handling tests:
- Handles variant not found (404)
- Handles unauthorized access (401)

Use mock responses matching the Inventory Planner API structure:
- Variant response: { id, sku, title, full_title, lead_time, review_period, safety_stock, reorder_point, active }

Key patterns:
- For preview tests: do NOT mock API - verify NO fetch was called
- For confirm tests: mock the PATCH /variants/:id response
- Use non-retryable errors (401, 403, 404) to avoid retry timeouts
- Parse results with callTool helper returning { result, isError }
  </action>
  <verify>npm test --prefix mcp/inventory-planner -- --run mutations.test.ts passes with 10+ tests</verify>
  <done>update_variant tool has comprehensive integration tests covering VAR-01</done>
</task>

</tasks>

<verification>
Run full test suite to confirm no regressions:

```bash
npm test --prefix mcp/inventory-planner -- --run
```

Expected: All tests pass including new mutations.test.ts (~10-12 tests)
</verification>

<success_criteria>
1. mutations.test.ts exists with 10+ tests
2. update_variant tool tested for preview and confirm modes
3. All planning parameters tested (lead_time, review_period, safety_stock, reorder_point, active)
4. Error handling tested with non-retryable errors
5. All tests pass
6. Total project test count increases by ~10-12
</success_criteria>

<output>
After completion, create `.planning/phases/03-purchase-order-mutations/03-02-SUMMARY.md`
</output>
