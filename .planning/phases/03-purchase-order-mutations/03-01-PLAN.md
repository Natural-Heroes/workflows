---
phase: 03-purchase-order-mutations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - mcp/inventory-planner/src/mcp/tools/purchase-orders.test.ts
autonomous: true

must_haves:
  truths:
    - "User can list purchase orders with filters (status, vendor, date range)"
    - "User can view complete purchase order details including all line items"
    - "User can create purchase orders with preview-before-execute confirmation flow"
    - "User can update purchase order status, dates, and notes"
    - "User can record received quantities on PO items"
  artifacts:
    - path: "mcp/inventory-planner/src/mcp/tools/purchase-orders.test.ts"
      provides: "Integration tests for all 5 PO tools"
      min_lines: 400
  key_links:
    - from: "purchase-orders.test.ts"
      to: "purchase-orders.ts"
      via: "MCP tool calls through supertest"
      pattern: "callTool.*get_purchase_order"
---

<objective>
Validate all 5 purchase order tools (get_purchase_orders, get_purchase_order, create_purchase_order, update_purchase_order, update_received_qty) with comprehensive integration tests.

Purpose: Verify PO-01 through PO-05 requirements are met with tests covering success paths, preview mode, confirmation mode, error handling, and edge cases.

Output: purchase-orders.test.ts with ~25-30 tests covering all PO tools.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-stock-analytics-completion/02-01-SUMMARY.md

# Source files to test
@mcp/inventory-planner/src/mcp/tools/purchase-orders.ts

# Test patterns to follow
@mcp/inventory-planner/src/mcp/tools/variants.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create purchase-orders.test.ts with read tool tests</name>
  <files>mcp/inventory-planner/src/mcp/tools/purchase-orders.test.ts</files>
  <action>
Create comprehensive integration tests for get_purchase_orders and get_purchase_order tools.

Follow the EXACT test patterns from variants.test.ts:
1. Same imports (vitest, vitest-fetch-mock, supertest)
2. Same environment variable setup at top of file
3. Same parseSSEResponse, initializeSession, callTool helper functions
4. Same beforeEach/afterEach setup with fetchMocker

Tests for get_purchase_orders (PO-01):
- Returns paginated list with status summary and total value
- Filters by status (open, received, etc.)
- Filters by vendor_id
- Filters by warehouse_id
- Filters by date range (expected_date_gt, expected_date_lt)
- Filters by type (purchase_order, transfer, assembly)
- Returns empty result message when no orders match
- Handles API errors (use 401/403/404 to avoid retry delays)

Tests for get_purchase_order (PO-02):
- Returns full order details with line items
- Includes vendor/warehouse info
- Includes dates (order, expected, received)
- Includes financial data (total, currency, shipping)
- Returns items with ordered and received quantities
- Handles not found errors (404)

Use mock responses matching the Inventory Planner API structure:
- PO response: { id, number, type, status, vendor_id, vendor_name, warehouse_id, warehouse_name, order_date, expected_date, total, currency, items: [...] }
- Item: { id, variant_id, sku, title, quantity, received_quantity, cost, total }
  </action>
  <verify>npm test --prefix mcp/inventory-planner -- --run purchase-orders.test.ts passes with 14+ tests</verify>
  <done>get_purchase_orders and get_purchase_order tools have integration test coverage for PO-01 and PO-02</done>
</task>

<task type="auto">
  <name>Task 2: Add write tool tests (create, update, received qty)</name>
  <files>mcp/inventory-planner/src/mcp/tools/purchase-orders.test.ts</files>
  <action>
Add tests for write operations to purchase-orders.test.ts.

Tests for create_purchase_order (PO-03):
- Preview mode (confirm=false) returns preview object without API call
- Confirm mode (confirm=true) creates order and returns success
- Preview shows itemCount and totalQuantity
- Confirms order includes vendor_id, warehouse_id, items
- Handles validation errors (missing required fields)
- Handles API errors on creation

Tests for update_purchase_order (PO-04):
- Preview mode returns preview of changes without API call
- Confirm mode updates order and returns success
- Can update status
- Can update expected_date
- Can update notes and reference
- Handles not found errors (404)

Tests for update_received_qty (PO-05):
- Preview mode returns preview without API call
- Confirm mode updates received quantities
- Returns updated items with ordered vs received
- Handles order not found errors
- Handles item not found errors

Key patterns:
- For preview tests: do NOT mock API - verify NO fetch was called
- For confirm tests: mock the API response
- Use non-retryable errors (401, 403, 404, 400) to avoid retry timeouts
- Parse results with callTool helper returning { result, isError }
  </action>
  <verify>npm test --prefix mcp/inventory-planner -- --run purchase-orders.test.ts passes with 25+ tests</verify>
  <done>All 5 PO tools have comprehensive integration tests covering PO-01 through PO-05</done>
</task>

</tasks>

<verification>
Run full test suite to confirm no regressions:

```bash
npm test --prefix mcp/inventory-planner -- --run
```

Expected: All tests pass including new purchase-orders.test.ts (~25-30 tests)
</verification>

<success_criteria>
1. purchase-orders.test.ts exists with 25+ tests
2. All 5 PO tools tested (get_purchase_orders, get_purchase_order, create_purchase_order, update_purchase_order, update_received_qty)
3. Preview vs confirm mode tested for all write tools
4. Error handling tested with non-retryable errors
5. All tests pass
6. Total project test count increases by ~25-30
</success_criteria>

<output>
After completion, create `.planning/phases/03-purchase-order-mutations/03-01-SUMMARY.md`
</output>
